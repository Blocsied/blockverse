<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>BlockVerse</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        /* UI styling (identical to original) */
        :root{--bg-body:#0a0a0c;--bg-panel:rgba(26,26,30,0.85);--bg-element:#1c1c21;--primary:#3b82f6;--primary-hover:#2563eb;--accent:#8b5cf6;--text-main:#f8fafc;--text-muted:#94a3b8;--border:rgba(255,255,255,0.1);--danger:#ef4444;--success:#10b981;--warning:#f59e0b;--glass:blur(12px)}*{box-sizing:border-box;outline:none;transition:background .15s,border-color .15s,transform .1s}body{margin:0;background:var(--bg-body);color:var(--text-main);font-family:'Inter',-apple-system,sans-serif;font-size:14px;overflow-x:hidden;background-image:radial-gradient(circle at 50% -20%, #1e293b 0%, #0a0a0c 100%);min-height:100vh}::-webkit-scrollbar{width:8px}::-webkit-scrollbar-track{background:var(--bg-body)}::-webkit-scrollbar-thumb{background:#333;border-radius:4px}::-webkit-scrollbar-thumb:hover{background:#444}.btn{padding:10px 18px;border:none;border-radius:8px;font-weight:600;cursor:pointer;color:white;display:inline-flex;align-items:center;justify-content:center;gap:8px;font-size:13px;text-decoration:none;user-select:none}.btn-primary{background:var(--primary);box-shadow:0 4px 12px rgba(59,130,246,.3)}.btn-primary:hover{background:var(--primary-hover);transform:translateY(-1px)}.btn-danger{background:var(--danger);box-shadow:0 4px 12px rgba(239,68,68,.2)}.btn-success{background:var(--success);box-shadow:0 4px 12px rgba(16,185,129,.2)}.btn-outline{background:rgba(255,255,255,.05);border:1px solid var(--border);color:var(--text-main)}.btn-outline:hover{background:rgba(255,255,255,.1);border-color:rgba(255,255,255,.2)}.btn-sm{padding:6px 12px;font-size:11px;border-radius:6px}input,select,textarea{background:rgba(0,0,0,.3);border:1px solid var(--border);color:white;padding:12px;border-radius:8px;width:100%;margin-bottom:12px;font-family:inherit}input:focus,select:focus,textarea:focus{border-color:var(--primary);box-shadow:0 0 0 2px rgba(59,130,246,.2)}.card{background:var(--bg-panel);backdrop-filter:var(--glass);border:1px solid var(--border);border-radius:16px;padding:24px;margin-bottom:20px;box-shadow:0 10px 30px rgba(0,0,0,.3)}.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:20px}.container{max-width:1200px;margin:40px auto;padding:0 24px;display:none;opacity:0;transform:translateY(10px);transition:opacity .3s ease,transform .3s ease}.container.active{display:block;opacity:1;transform:translateY(0)}.hidden{display:none!important}#navbar{height:70px;background:rgba(10,10,12,.8);backdrop-filter:blur(20px);border-bottom:1px solid var(--border);display:flex;align-items:center;padding:0 40px;position:sticky;top:0;z-index:1000}.nav-logo{font-size:24px;font-weight:900;background:linear-gradient(45deg,var(--primary),var(--accent));-webkit-background-clip:text;-webkit-text-fill-color:transparent;margin-right:40px;cursor:pointer;letter-spacing:-1px}.nav-items{display:flex;gap:8px;flex:1}.nav-link{color:var(--text-muted);font-weight:600;cursor:pointer;padding:8px 14px;border-radius:8px;font-size:13px;transition:.2s}.nav-link:hover,.nav-link.active{color:white;background:rgba(255,255,255,.08)}.nav-user{display:flex;gap:16px;align-items:center;position:relative}.currency-badge{background:rgba(245,158,11,.1);border:1px solid rgba(245,158,11,.2);padding:6px 12px;border-radius:20px;font-weight:700;font-size:12px;color:var(--warning);display:flex;align-items:center;gap:6px;cursor:default}#currency-tooltip{position:absolute;top:48px;right:0;transform:translateY(6px);background:var(--bg-panel);border:1px solid var(--border);padding:8px 10px;border-radius:8px;font-size:12px;display:none;white-space:nowrap}#notification-area{position:fixed;bottom:30px;right:30px;z-index:2000;display:flex;flex-direction:column;gap:10px;pointer-events:none}.toast{pointer-events:all;background:var(--bg-panel);backdrop-filter:var(--glass);border-left:4px solid var(--primary);padding:16px 20px;border-radius:12px;box-shadow:0 10px 40px rgba(0,0,0,.5);animation:slideIn .3s cubic-bezier(.2,.8,.2,1) forwards;min-width:280px;color:white;border:1px solid var(--border);font-size:13px}@keyframes slideIn{from{transform:translateX(100%);opacity:0}to{transform:translateX(0);opacity:1}}#app-viewport{position:fixed;top:0;left:0;width:100vw;height:100vh;background:#000;z-index:1500;display:none}#studio-ui{position:absolute;inset:0;pointer-events:none;display:flex;flex-direction:column;padding:15px}.studio-panel{background:rgba(20,20,25,.9);backdrop-filter:blur(10px);border:1px solid var(--border);border-radius:12px;pointer-events:all;padding:16px;box-shadow:0 8px 32px rgba(0,0,0,.5)}.toolbox-item{padding:10px;background:rgba(255,255,255,.03);border-radius:8px;margin-bottom:6px;cursor:pointer;font-size:12px;display:flex;align-items:center;gap:10px;font-weight:500;border:1px solid transparent}.toolbox-item:hover{background:rgba(255,255,255,.08);border-color:rgba(255,255,255,.1)}.toolbox-color{width:12px;height:12px;border-radius:3px}.avatar-render-container{background:radial-gradient(circle at center,#2d3748,#0f172a);border-radius:12px;position:relative;overflow:hidden;border:1px solid var(--border)}.user-row{display:flex;align-items:center;padding:12px;background:var(--bg-element);margin-bottom:8px;cursor:pointer;border-radius:10px;border:1px solid transparent}.user-row:hover{border-color:var(--border);background:rgba(255,255,255,.05)}.user-avatar-small{width:42px;height:42px;border-radius:50%;margin-right:15px;overflow:hidden}#admin-plus{position:fixed;bottom:30px;left:30px;width:50px;height:50px;background:var(--danger);border-radius:50%;display:none;align-items:center;justify-content:center;cursor:pointer;z-index:1000;box-shadow:0 5px 20px rgba(239,68,68,.4);font-size:24px;color:white;transition:transform .2s}#admin-plus:hover{transform:scale(1.1)}.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.8);backdrop-filter:blur(5px);z-index:2500;display:none;align-items:center;justify-content:center}.modal-content{background:var(--bg-panel);border:1px solid var(--border);padding:30px;border-radius:20px;width:500px;max-width:90%;max-height:90vh;overflow-y:auto;box-shadow:0 20px 50px rgba(0,0,0,.5)}#overlay-purged{position:fixed;inset:0;background:#000;display:none;flex-direction:column;align-items:center;justify-content:center;z-index:9999;color:var(--danger);font-family:monospace;font-size:20px;letter-spacing:2px}.explorer-item{padding:6px 10px;font-size:11px;color:#ccc;cursor:pointer;border-radius:4px}.explorer-item:hover{background:rgba(255,255,255,.1)}.explorer-item.active{background:var(--primary);color:white}.studio-hint{position:absolute;left:50%;top:14px;transform:translateX(-50%);background:rgba(0,0,0,.5);color:#eee;padding:6px 10px;border-radius:8px;font-size:12px;pointer-events:none}.friends-row{display:flex;gap:8px;align-items:center;margin-top:12px;justify-content:center}.friend-pill{background:rgba(255,255,255,.03);padding:6px 10px;border-radius:999px;display:flex;gap:8px;align-items:center;font-size:13px;cursor:pointer;border:1px solid transparent}.friend-pill:hover{border-color:var(--border);background:rgba(255,255,255,.06)}/* health bar */#health-bar-wrap{position:absolute;left:50%;transform:translateX(-50%);bottom:18px;width:320px;height:22px;background:rgba(0,0,0,0.45);border-radius:12px;border:1px solid var(--border);display:flex;align-items:center;padding:3px 6px;pointer-events:none}#health-bar{height:100%;width:100%;background:rgba(255,255,255,0.06);border-radius:8px;overflow:hidden}#health-bar-fill{height:100%;width:100%;background:linear-gradient(90deg,#10b981,#f59e0b);transition:width 0.2s}#health-text{position:absolute;left:50%;transform:translateX(-50%);color:white;font-weight:700;font-size:12px;pointer-events:none}
        #loading-overlay { position: fixed; inset: 0; background: #0a0a0c; z-index: 9999; display: flex; align-items: center; justify-content: center; flex-direction: column; font-family: 'Inter', sans-serif; transition: opacity 0.5s; }
        .spinner { width: 40px; height: 40px; border: 4px solid rgba(255,255,255,0.1); border-left-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div id="loading-overlay">
    <div class="spinner"></div>
    <div style="margin-top:20px; color: var(--text-muted); font-size: 13px; letter-spacing: 1px;">CONNECTING TO SERVER...</div>
</div>

<div id="notification-area"></div>

<div id="admin-plus" title="Admin Panel" onclick="UI.toggleAdminModal()">+</div>
<div id="admin-modal" class="modal-overlay"><div id="admin-modal-content" class="modal-content"></div></div>
<div id="daily-modal" class="modal-overlay"><div id="daily-modal-content" class="modal-content"></div></div>
<div id="asset-preview-modal" class="modal-overlay"><div id="asset-preview-content" class="modal-content"></div></div>
<div id="overlay-purged">
    <div style="font-size:60px;">‚ö†Ô∏è</div>
    <div style="margin-top:20px;">SYSTEM PURGE IN PROGRESS</div>
    <div style="font-size:14px;opacity:0.6;margin-top:10px;">Only administrators may access the platform.</div>
</div>

<nav id="navbar" class="hidden">
    <div class="nav-logo" onclick="Router.go('home')">BLOCKVERSE</div>
    <div class="nav-items">
        <div class="nav-link" id="nav-home" onclick="Router.go('home')">Home</div>
        <div class="nav-link" id="nav-games" onclick="Router.go('games')">Games</div>
        <div class="nav-link" id="nav-catalog" onclick="Router.go('catalog')">Catalog</div>
        <div class="nav-link" id="nav-create" onclick="Router.go('create')">Create</div>
        <div class="nav-link" id="nav-users" onclick="Router.go('users')">Community</div>
        <div class="nav-link" id="nav-avatar" onclick="Router.go('avatar')">Avatar</div>
        <div class="nav-link" id="nav-inbox" onclick="Router.go('inbox')">Inbox</div>
    </div>
    <div class="nav-user">
        <div class="currency-badge" id="nav-currency-badge">
            <div style="width:8px;height:8px;background:gold;border-radius:50%;"></div>
            <span id="nav-currency">0</span>
        </div>
        <div id="currency-tooltip">Next daily in: --</div>
        <div style="font-weight:700;cursor:pointer;" onclick="Router.viewProfile(API.user.username)" id="nav-username">User</div>
        <button class="btn btn-outline btn-sm" onclick="API.logout()">Logout</button>
    </div>
</nav>

<div id="page-auth" class="container active" style="max-width:400px;margin-top:10vh;text-align:center;">
    <div class="card" style="padding:40px;">
        <h1 style="background:linear-gradient(to right,#fff,#888);-webkit-background-clip:text;-webkit-text-fill-color:transparent;font-size:32px;margin-bottom:10px;">BlockVerse</h1>
        <p style="color:var(--text-muted);margin-bottom:30px;">Build. Play. Connect.</p>

        <input type="text" id="login-user" placeholder="Username" style="text-align:center;">
        <input type="password" id="login-pass" placeholder="Password" style="text-align:center;">

        <button class="btn btn-primary" style="width:100%;margin-top:10px;" onclick="API.login()">Enter World</button>

        <div style="margin-top:20px;">
            <a onclick="document.getElementById('reg-fields').classList.toggle('hidden')" style="font-size:12px;color:var(--text-muted);cursor:pointer;text-decoration:underline;">Create a new account</a>
        </div>

        <div id="reg-fields" class="hidden" style="margin-top:20px;border-top:1px solid var(--border);padding-top:20px;">
            <input type="password" id="reg-pass-conf" placeholder="Confirm Password" style="text-align:center;">
            <button class="btn btn-success" style="width:100%;" onclick="API.register()">Sign Up</button>
        </div>
    </div>
</div>

<div id="page-home" class="container">
    <div style="display:flex;gap:30px;">
        <div style="width:300px;flex-shrink:0;">
            <div class="card" style="text-align:center;">
                <div class="avatar-render-container" id="home-avatar-view" style="height:280px;margin-bottom:20px;"></div>
                <h2 id="home-welcome" style="margin:0;">Hello!</h2>
                <div style="font-size:12px;color:var(--text-muted);margin-top:5px;">Member since <span id="home-join-date"></span></div>
                <div id="home-friends-container" style="margin-top:12px;"></div>
            </div>
        </div>

        <div style="flex:1;">
            <div class="card" style="border-left:4px solid var(--primary);">
                <h3 style="margin-top:0;">Welcome back to BlockVerse.</h3>
                <p style="color:var(--text-muted);line-height:1.5;">Welcome to BlockVerse Cloud Edition. All data is now synced to the server.</p>
            </div>

            <h3 style="display:flex;align-items:center;gap:10px;">Recommended <span style="font-size:12px;font-weight:normal;color:var(--text-muted);background:rgba(255,255,255,0.05);padding:2px 8px;border-radius:4px;">Featured</span></h3>
            <div class="grid" id="home-rec-games"></div>
        </div>
    </div>
</div>

<div id="page-games" class="container">
    <div style="display:flex;justify-content:space-between;align-items:flex-end;margin-bottom:20px;">
        <h1 style="margin:0;">Explore</h1>
        <input type="text" placeholder="Search games..." style="width:250px;margin:0;" onkeyup="UI.searchGames(this.value)">
    </div>
    <div class="grid" id="games-list"></div>
</div>

<div id="page-game" class="container">
    <div class="card">
        <button class="btn btn-outline btn-sm" onclick="Router.go('games')" style="margin-bottom:20px;">&larr; Back to Games</button>
        <div style="display:flex;gap:30px;">
            <div style="width:300px;">
                <div id="game-thumbnail" style="width:100%;height:200px;border-radius:12px;background:#333;display:flex;align-items:center;justify-content:center;margin-bottom:20px;border:1px solid var(--border);"></div>
                <button class="btn btn-primary" style="width:100%;font-size:16px;padding:14px;" id="game-play-btn">PLAY NOW</button>
                <div style="display:flex;gap:10px;margin-top:10px;">
                    <button class="btn btn-outline" style="flex:1;" id="game-config-btn">Edit</button>
                    <button class="btn btn-outline" style="flex:1;color:var(--danger);border-color:rgba(239,68,68,.3);" id="game-flag-btn">Report</button>
                </div>
            </div>
            <div style="flex:1;">
                <h1 id="game-title" style="margin-top:0;font-size:32px;">Game Title</h1>
                <div style="display:flex;gap:15px;color:var(--text-muted);font-size:13px;margin-bottom:20px;">
                    <span>By <strong id="game-creator" style="color:white;cursor:pointer;">User</strong></span>
                    <span>‚Ä¢</span>
                    <span>Rating: <strong id="game-rating" style="color:var(--warning);">0</strong></span>
                    <span>‚Ä¢</span>
                    <span><span id="game-players-count">0</span> Playing</span>
                </div>
                <p id="game-desc" style="line-height:1.6;color:#ddd;min-height:60px;">No description.</p>

                <div style="display:flex;gap:10px;margin-bottom:30px;">
                    <button class="btn btn-outline btn-sm" onclick="UI.rateGame(currentViewingGameId, 1)">üëç Like</button>
                    <button class="btn btn-outline btn-sm" onclick="UI.rateGame(currentViewingGameId, -1)">üëé Dislike</button>
                </div>

                <hr style="border:0;border-top:1px solid var(--border);margin:20px 0;">

                <h3>Comments</h3>
                <div style="display:flex;gap:10px;margin-bottom:20px;">
                    <input id="comment-text" placeholder="Write a comment..." style="margin:0;">
                    <button class="btn btn-primary" onclick="UI.postComment(currentViewingGameId)">Post</button>
                </div>
                <div id="comment-list" style="max-height:300px;overflow-y:auto;display:flex;flex-direction:column;gap:10px;"></div>
            </div>
        </div>
    </div>
</div>

<div id="page-catalog" class="container">
    <div style="display:flex;gap:30px;">
        <div style="width:220px;">
            <div class="card">
                <h4 style="margin-top:0;">Categories</h4>
                <div style="display:flex;flex-direction:column;gap:8px;">
                    <a class="nav-link" onclick="UI.renderCatalog('shirt')">Shirts</a>
                    <a class="nav-link" onclick="UI.renderCatalog('pants')">Pants</a>
                    <a class="nav-link" onclick="UI.renderCatalog('hat')">Accessories</a>
                    <a class="nav-link" onclick="UI.renderCatalog('face')">Faces</a>
                    <a class="nav-link" onclick="UI.renderCatalog('audio')">Audio</a>
                    <a class="nav-link" onclick="UI.renderCatalog('decal')">Decals</a>
                    <a class="nav-link" onclick="UI.renderCatalog('model')">Models</a>
                </div>
            </div>
        </div>

        <div style="flex:1;">
            <h1 style="margin-top:0;">Catalog</h1>
            <div class="grid" id="catalog-grid"></div>
        </div>
    </div>
</div>

<div id="page-create" class="container">
    <div class="card" style="background: linear-gradient(90deg, rgba(59, 130, 246, 0.2), transparent); border-color: var(--primary);">
        <div style="display:flex;justify-content:space-between;align-items:center;">
            <div>
                <h2 style="margin:0;">BlockVerse Studio</h2>
                <p style="color:var(--text-muted);margin:5px 0 0 0;">Create worlds. Script events. Publish to millions.</p>
            </div>
            <div style="display:flex;gap:10px;">
                <button class="btn btn-primary" onclick="Studio.createDisplay()">+ Create New Game</button>
                <button class="btn btn-outline" onclick="UI.openImportModal()">Import .blockverse</button>
            </div>
        </div>
    </div>

    <div style="display:flex;gap:30px;">
        <div style="flex:1;">
            <h3>My Games</h3>
            <div class="grid" id="my-games-list"></div>
        </div>

        <div style="width:300px;">
            <div class="card">
                <h3>UGC Creator</h3>
                <p style="font-size:12px;color:var(--text-muted);">Upload textures to sell. (Players: shirts, pants, faces only)</p>
                <select id="user-up-type">
                    <option value="shirt">Shirt</option>
                    <option value="pants">Pants</option>
                    <option value="face">Face</option>
                </select>
                <input type="text" id="user-up-name" placeholder="Item Name">
                <input type="text" id="user-up-url" placeholder="Image / Asset URL">
                <input type="number" id="user-up-price" placeholder="Sell Price">
                <button class="btn btn-success" style="width:100%;" onclick="API.userUploadWithPreview()">Upload (10 Coins)</button>
            </div>

            <div class="card hidden" id="admin-upload-panel-create" style="border-color:var(--danger); margin-top:12px;">
                <h5 style="color:var(--danger);margin-top:0;">Admin Upload</h5>
                <select id="adm-up-type-create" style="padding:8px;font-size:12px;">
                    <option value="hat">Hat (Mesh)</option>
                    <option value="shirt">Shirt</option>
                    <option value="pants">Pants</option>
                    <option value="face">Face</option>
                    <option value="audio">Audio</option>
                    <option value="decal">Decal</option>
                    <option value="model">Model</option>
                </select>
                <input type="text" id="adm-up-name-create" placeholder="Name" style="padding:8px;">
                <input type="text" id="adm-up-url-create" placeholder="Asset URL" style="padding:8px;">
                <input type="number" id="adm-up-price-create" placeholder="Price" style="padding:8px;" value="0">
                <button class="btn btn-danger btn-sm" style="width:100%" onclick="API.adminUploadWithPreviewFromCreate()">Upload Official</button>
            </div>

            <div class="card" style="margin-top:16px;">
                <h4 style="margin-top:0;">Creator Catalogue</h4>
                <div id="creator-catalog" style="max-height:360px;overflow-y:auto;"></div>
            </div>
        </div>
    </div>
</div>

<div id="page-avatar" class="container">
    <div class="card">
        <h1 style="margin:0 0 20px 0;">Avatar Editor</h1>
        <div style="display:flex;gap:40px;">
            <div style="width:350px;">
                <div class="avatar-render-container" id="avatar-edit-view" style="height:400px;margin-bottom:20px;"></div>
                <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin-bottom:15px;">
                    <div><label style="font-size:10px;">SKIN</label><input type="color" id="avatar-head" value="#cdcdcd" style="padding:0;height:35px;"></div>
                    <div><label style="font-size:10px;">TORSO</label><input type="color" id="avatar-torso" value="#3b82f6" style="padding:0;height:35px;"></div>
                    <div><label style="font-size:10px;">LEGS</label><input type="color" id="avatar-legs" value="#1e293b" style="padding:0;height:35px;"></div>
                </div>
                <button class="btn btn-primary" style="width:100%;" onclick="UI.saveAvatar()">Save Character</button>
            </div>
            <div style="flex:1;">
                <h3>Inventory</h3>
                <div id="avatar-inventory" class="grid" style="grid-template-columns:repeat(auto-fill,minmax(150px,1fr));"></div>
            </div>
        </div>
    </div>
</div>

<div id="page-users" class="container">
    <h1 style="margin-top:0;">Community</h1>
    <input type="text" placeholder="Search users..." onkeyup="UI.filterUsers(this.value)">
    <div id="users-list" style="margin-top:20px;"></div>
</div>

<div id="page-profile" class="container">
    <div class="card">
        <div style="position:absolute;right:24px;top:24px;">
            <button class="btn btn-outline btn-sm" id="profile-settings-btn" onclick="API.showAccountSettings()" style="display:none;">Settings</button>
        </div>
        <div style="display:flex;gap:30px;">
            <div style="width:250px;">
                <div class="avatar-render-container" id="profile-avatar-view" style="height:250px;"></div>
            </div>
            <div style="flex:1;">
                <h1 id="prof-name" style="margin-top:0;">Username</h1>
                <div style="display:flex;gap:8px;align-items:center;margin-bottom:6px;">
                    <div id="prof-title" style="font-size:12px;color:var(--text-muted)"></div>
                    <div id="prof-friend-btn"></div>
                </div>
                <p id="prof-desc" style="color:var(--text-muted);font-style:italic;">No description.</p>
                <div id="prof-edit-desc" class="hidden" style="margin-bottom:15px;">
                    <textarea id="prof-desc-input" rows="2"></textarea>
                    <button class="btn btn-sm btn-primary" onclick="API.updateBio()">Update Bio</button>
                </div>
                <div style="display:grid;grid-template-columns:auto auto;gap:20px;font-size:13px;margin-top:20px;">
                    <div><strong>Join Date:</strong> <span id="prof-date"></span></div>
                    <div><strong>Status:</strong> <span id="prof-status">Offline</span></div>
                </div>
                <div id="admin-actions" class="hidden" style="margin-top:20px;border-top:1px solid var(--danger);padding-top:15px;">
                    <strong style="color:var(--danger);display:block;margin-bottom:10px;">Admin Zone</strong>
                    <button class="btn btn-danger btn-sm" onclick="API.banUser()">Ban User</button>
                    <button class="btn btn-outline btn-sm" onclick="API.giveCurrency()">Gift 1000 Coins</button>
                </div>
            </div>
        </div>
    </div>
    <h3>Items Owned</h3>
    <div class="grid" id="prof-inventory"></div>
</div>

<div id="page-inbox" class="container">
    <div class="card" style="min-height:600px;display:flex;gap:20px;">

        <div style="width:250px;border-right:1px solid var(--border);padding-right:20px;display:flex;flex-direction:column;">

            <button class="btn btn-primary"
                style="margin-bottom:15px;"
                onclick="document.getElementById('msg-compose').classList.remove('hidden');">
                New Message
            </button>

            <div style="margin-bottom:10px;">
                <h4 style="margin:0 0 5px 0;">Friend Requests</h4>
                <div id="inbox-requests" style="overflow-y:auto;max-height:150px;"></div>
            </div>

            <div style="flex:1;">
                <h4 style="margin:0 0 5px 0;">Messages</h4>
                <div id="inbox-list" style="overflow-y:auto;height:100%;"></div>
            </div>
        </div>

        <div style="flex:1;display:flex;flex-direction:column;">

            <div id="inbox-view" style="flex:1;">
                <div style="color:var(--text-muted);display:flex;align-items:center;justify-content:center;height:100%;">
                    Select a message
                </div>
            </div>

            <div id="msg-compose" class="hidden"
                style="border-top:1px solid var(--border);padding-top:15px;margin-top:15px;">
                <h4>Send Message</h4>
                <input id="msg-recipient" placeholder="Recipient Username">
                <textarea id="msg-content" placeholder="Type your message..." rows="3"></textarea>
                <button class="btn btn-primary" onclick="API.sendMessage()">Send</button>
            </div>

        </div>
    </div>
</div>

<div id="app-viewport">
    <div id="viewport"></div>

    <div id="studio-ui">
        <div style="display:flex;justify-content:space-between;pointer-events:none;">
            <div class="studio-panel" style="display:flex;align-items:center;gap:15px;">
                <button class="btn btn-danger btn-sm" onclick="Engine.exit()">Exit</button>
                <div style="height:20px;width:1px;background:var(--border);"></div>
                <span style="font-weight:800;font-size:11px;letter-spacing:1px;color:var(--warning);">STUDIO MODE</span>
            </div>
            <div class="studio-panel" style="display:flex;gap:10px;">
                <button class="btn btn-outline btn-sm" onclick="Studio.saveLocal()">Save Cloud</button>
                <button class="btn btn-primary btn-sm" onclick="Studio.publishModal()">Publish Game</button>
            </div>
        </div>

        <div style="display:flex;gap:15px;height:100%;overflow:hidden;margin-top:15px;pointer-events:none;">
            <div class="studio-panel" style="width:220px;display:flex;flex-direction:column;pointer-events:all;">
                <h4 style="margin:0 0 10px 0;font-size:12px;color:var(--text-muted);text-transform:uppercase;">Toolbox</h4>
                <div class="toolbox-item" onclick="Studio.addPart('block')"><div class="toolbox-color" style="background:#fff"></div> Cube</div>
                <div class="toolbox-item" onclick="Studio.addPart('spawn')"><div class="toolbox-color" style="background:#888"></div> Spawn</div>
                <div class="toolbox-item" onclick="Studio.addPart('kill')"><div class="toolbox-color" style="background:#f00"></div> Kill Brick</div>
                <div class="toolbox-item" onclick="Studio.addPart('finish')"><div class="toolbox-color" style="background:gold"></div> Win Pad</div>
                <div class="toolbox-item" onclick="Studio.addPart('light')"><div class="toolbox-color" style="background:#ffb"></div> Lamp</div>

                <hr style="border:0;border-top:1px solid var(--border);margin:15px 0;">

                <h4 style="margin:0 0 10px 0;font-size:12px;color:var(--text-muted);text-transform:uppercase;">Properties</h4>
                <div id="prop-panel" style="font-size:12px;">Select an object.</div>
            </div>

            <div style="flex:1;"></div>

            <div class="studio-panel" style="width:200px;display:flex;flex-direction:column;pointer-events:all;">
                <h4 style="margin:0 0 10px 0;font-size:12px;color:var(--text-muted);text-transform:uppercase;">Explorer</h4>
                <div id="studio-explorer" style="flex:1;overflow-y:auto;"></div>
            </div>
        </div>

        <div class="studio-hint">Right-drag to orbit, middle-drag to pan, scroll to zoom. Click object to select. Drag gizmos to move/scale.</div>
    </div>

    <div id="health-bar-wrap" style="display:none;">
        <div id="health-bar"><div id="health-bar-fill" style="width:100%"></div></div>
        <div id="health-text">100%</div>
    </div>

    <div id="in-game-menu" class="hidden" style="position:absolute;top:20px;left:20px;pointer-events:all;">
        <button class="btn btn-outline" style="background:rgba(0,0,0,.5);" onclick="Engine.openSettings()">Menu</button>
    </div>
</div>

<div id="in-game-settings" class="modal-overlay">
    <div class="modal-content" style="width:300px;">
        <h3>Menu</h3>
        <label>Mouse Sensitivity</label>
        <input id="setting-sens" type="range" min="0.1" max="3" step="0.1" value="1">
        <div style="margin-top:20px;display:flex;justify-content:flex-end;gap:10px;">
            <button class="btn btn-outline" onclick="Engine.closeSettings()">Resume</button>
            <button class="btn btn-danger" onclick="Engine.exit()">Leave Game</button>
        </div>
    </div>
</div>

<div id="game-config-modal" class="modal-overlay">
    <div class="modal-content">
        <h3>Configure Universe</h3>
        <label>Name</label><input id="cfg-name">
        <label>Description</label><textarea id="cfg-desc"></textarea>
        <label>Thumbnail Color</label><input id="cfg-thumb" type="color">
        <div style="margin-top:20px;display:flex;justify-content:flex-end;gap:10px;">
            <button class="btn btn-outline" onclick="UI.closeGameConfig()">Cancel</button>
            <button class="btn btn-primary" onclick="UI.saveGameConfig()">Save Changes</button>
        </div>
    </div>
</div>

<div id="account-settings" class="modal-overlay">
    <div class="modal-content">
        <h3>Account Settings</h3>
        <label>Email</label><input id="acct-email">
        <label>New Password</label><input id="acct-password" type="password">
        <label>Privacy</label>
        <select id="acct-privacy">
            <option value="public">Public</option>
            <option value="private">Private</option>
        </select>
        <div style="margin-top:20px;display:flex;justify-content:flex-end;gap:10px;">
            <button class="btn btn-outline" onclick="document.getElementById('account-settings').style.display='none'">Close</button>
            <button class="btn btn-primary" onclick="API.saveAccountSettings()">Save</button>
        </div>
    </div>
</div>

<script>
/* ==========================================================================
   CONFIG
   ========================================================================== */

// IMPORTANT: keep the protocol (https://) here.
const SERVER_URL = "https://blockverse.blocdeveloperczech.workers.dev";
const API_URL = SERVER_URL.replace(/\/$/, "");

// TEMP DEBUG: remove this console.log once everything is confirmed working.
console.log("API_URL IN USE:", API_URL);

/* ==========================================================================
   CORE DATA & LOADING
   ========================================================================== */
const DB = {
  users: [],
  games: [],
  catalog: [],
  messages: [],
  moderation: [],
  sitePurged: false,

  initAsync: async function () {
    try {
      // Helpful debug: show the exact URL we will fetch.
      console.log("Attempting to connect to:", `${API_URL}/load`);

      const res = await fetch(`${API_URL}/load`, {
        method: "GET",
        headers: {
          "Accept": "application/json"
        }
      });

      if (!res.ok) {
        // capture body for better debugging
        const body = await res.text().catch(() => "(no body)");
        throw new Error(`Server returned ${res.status} ${res.statusText} - ${body}`);
      }

      // parse JSON (throw if invalid)
      let data;
      try {
        data = await res.json();
      } catch (jsonErr) {
        const txt = await res.text().catch(() => "(no body)");
        throw new Error("Invalid JSON from server: " + txt);
      }

      this.users = data.users || [];
      this.games = data.games || [];
      this.catalog = data.catalog || [];
      this.messages = data.messages || [];
      this.moderation = data.moderation || [];
      this.sitePurged = data.sitePurged || false;

      // Create Admin if fresh
      if (!this.users.find(u => u.username === 'BlockVerse')) {
        this.users.push({
          username: 'BlockVerse', password: '123', joined: new Date().toLocaleDateString(), currency: 1000,
          bio: 'Platform Admin', isAdmin: true, title: 'SYSTEM', superAdmin: true, banned: false, inventory: [1,2],
          avatar: { shirt:1, pants:2, hat:null, face:null, body:'#cdcdcd', shirtColor:'#3b82f6', pantsColor:'#1e293b' },
          friends: [], online:false, email:btoa('admin@bv.com'), privacy:{profilePublic:true}, lastDaily: 0
        });
      }

      console.log("BlockVerse: Connected!", {
        usersCount: this.users.length,
        gamesCount: this.games.length
      });

    } catch (e) {
      // Better debugging: show full error.message
      console.error("Connection Failed:", e);
      alert("Connection Failed to " + API_URL + "\nError: " + (e && e.message ? e.message : e));
      // keep throwing if you want callers to handle it:
      // throw e;
    }
  },

  save: async function () {
    try {
      const payload = {
        users: this.users,
        games: this.games,
        catalog: this.catalog,
        messages: this.messages,
        moderation: this.moderation,
        sitePurged: this.sitePurged
      };

      const res = await fetch(`${API_URL}/save`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });

      if (!res.ok) {
        const body = await res.text().catch(() => "(no body)");
        console.error("Cloud Save Failed:", res.status, res.statusText, body);
      } else {
        // optional: check response body for confirmation
        try {
          const json = await res.json().catch(() => null);
          console.log("Cloud Save OK", json);
        } catch {
          console.log("Cloud Save OK (no JSON response)");
        }
      }
    } catch (err) {
      console.error("Cloud Save Failed (network):", err);
    }
  }
};

/* ========================================================================== 
   API & UX BEHAVIOR
   ========================================================================== */
const API = {
    user: null,

    init: async function(){
        await DB.initAsync();
        document.getElementById('loading-overlay').style.opacity = '0';
        setTimeout(() => document.getElementById('loading-overlay').remove(), 500);

        const session = sessionStorage.getItem('bv_session');
        if(session){
            const u = DB.users.find(x=>x.username===session);
            if(u && !u.banned){ this.user = u; this.user.status = "Online"; UI.init(); }
            else { Router.go('auth'); }
        } else Router.go('auth');
        
        if(DB.sitePurged && (!this.user || !this.user.isAdmin)) document.getElementById('overlay-purged').style.display = 'flex';
    },

    notify: function(msg, type='info'){
        const area = document.getElementById('notification-area');
        const el = document.createElement('div');
        el.className = 'toast';
        if(type === 'error'){ el.style.borderLeftColor = 'var(--danger)'; el.style.color = '#ffcccc'; }
        el.innerText = msg;
        area.appendChild(el);
        setTimeout(()=>{ el.style.opacity='0'; el.style.transform='translateX(100%)'; setTimeout(()=>el.remove(),300); }, 3000);
    },

    register: function(){
        const u = document.getElementById('login-user').value.trim();
        const p = document.getElementById('login-pass').value;
        const pc = document.getElementById('reg-pass-conf').value;
        if(!u || !p) return this.notify("Fields cannot be empty","error");
        if(p !== pc) return this.notify("Passwords do not match","error");
        if(DB.users.find(x=>x.username.toLowerCase()===u.toLowerCase())) return this.notify("Username taken","error");
        
        const newUser = { username:u, password:p, joined:new Date().toLocaleDateString(), currency:50, bio:"New to BlockVerse!", isAdmin:false, banned:false, inventory:[1,2], avatar:{shirt:1,pants:2,hat:null,face:null,body:'#cdcdcd',shirtColor:'#3b82f6',pantsColor:'#1e293b'}, friends:[], online:true, email:'', privacy:{profilePublic:true}, lastDaily:0, title:'' };
        DB.users.push(newUser); 
        DB.save(); 
        this.login();
    },

    login: function(){
        const u = document.getElementById('login-user').value.trim();
        const p = document.getElementById('login-pass').value;
        const user = DB.users.find(x => x.username.toLowerCase() === u.toLowerCase());
        if(!user || user.password !== p) return this.notify("Invalid credentials","error");
        if(user.banned) return this.notify("Account Banned","error");
        this.user = user;
        sessionStorage.setItem('bv_session', user.username);
        user.online = true; 
        DB.save(); 
        UI.init();
    },

    logout: function(){ 
        if(this.user) { this.user.online=false; DB.save(); }
        sessionStorage.removeItem('bv_session'); 
        window.location.reload(); 
    },

    buyItem: function(id){
        const item = DB.catalog.find(i=>i.id===id);
        if(!item) return;
        const owned = this.user.inventory.includes(id);
        if(owned){
            if(item.type==='shirt') this.user.avatar.shirt = (this.user.avatar.shirt === id) ? null : id;
            if(item.type==='pants') this.user.avatar.pants = (this.user.avatar.pants === id) ? null : id;
            if(item.type==='hat') this.user.avatar.hat = (this.user.avatar.hat === id) ? null : id;
            if(item.type==='face') this.user.avatar.face = (this.user.avatar.face === id) ? null : id;
            DB.save();
            if(Engine.players && Engine.players.length > 0){
                const pls = Engine.players.filter(p => p.username === this.user.username);
                pls.forEach(p => API.applyAvatarToMesh(this.user, p.mesh));
            }
            this.notify((this.user.avatar[item.type] === id) ? "Equipped " + item.name : "Unequipped " + item.name);
        } else {
            if(this.user.currency >= item.price){
                this.user.currency -= item.price;
                this.user.inventory.push(id);
                const system = DB.users.find(u => u.username === 'BlockVerse');
                if(system) system.currency += item.price;
                DB.save();
                this.notify("Purchased " + item.name);
            } else return this.notify("Not enough Funds","error");
        }
        DB.save(); UI.updateNav(); UI.renderCatalog(item.type); UI.renderAvatarEditor();
    },

    sendFriendRequest: function(targetUsername){
        if(!this.user) return;
        if(this.user.username === targetUsername) return this.notify("Can't friend yourself","error");
        const target = DB.users.find(u => u.username === targetUsername);
        if(!target) return this.notify("User not found","error");
        if(this.user.friends.includes(targetUsername)) return this.notify("Already friends","error");
        
        const exists = DB.messages.find(m => m.type === "friend_request" && m.from === this.user.username && m.to === targetUsername && m.status === "pending");
        if(exists) return this.notify("Request already pending","error");

        DB.messages.push({ id: Date.now(), type: "friend_request", from: this.user.username, to: targetUsername, time: new Date().toLocaleString(), status: "pending", note: `${this.user.username} sent a friend request` });
        DB.save();
        this.notify("Friend request sent");
    },

    respondFriendRequest: function(messageId, accept){
        const m = DB.messages.find(x => x.id === messageId && x.type === 'friend_request');
        if(!m) return this.notify("Request not found","error");
        if(m.status !== 'pending') return this.notify("Request already responded","error");
        m.status = accept ? 'accepted' : 'declined';
        
        if(accept){
            const a = DB.users.find(u => u.username === m.from);
            const b = DB.users.find(u => u.username === m.to);
            if(a && b){
                if(!a.friends.includes(b.username)) a.friends.push(b.username);
                if(!b.friends.includes(a.username)) b.friends.push(a.username);
                this.notify(`You and ${a.username} are now friends`);
            }
        } else {
            this.notify("Friend request declined");
        }
        DB.save();
        UI.renderInbox();
        UI.renderHome();
    },

    userUploadWithPreview: function(){
        const type = document.getElementById('user-up-type').value;
        const name = document.getElementById('user-up-name').value.trim();
        const url = document.getElementById('user-up-url').value.trim();
        const price = parseInt(document.getElementById('user-up-price').value) || 0;
        if(!name || !url) return this.notify("Missing details","error");
        if(this.user.currency < 10) return this.notify("Need 10 coins","error");
        const allowed = ['shirt','pants','face'];
        if(!allowed.includes(type)) return this.notify("That upload type is admin-only","error");

        UI.showAssetPreview(type, url, name, price, (confirmed) => {
            if(!confirmed) return this.notify("Upload cancelled");
            this.user.currency -= 10;
            const item = { id: Date.now(), type:type, name:name, creator:this.user.username, price:price, url:url, approved:false, madeBy:this.user.username };
            DB.catalog.push(item);
            DB.moderation.push({ id: Date.now()+1, type:'asset', targetId:item.id, who:this.user.username, reason:'Pending review', time:new Date().toLocaleString() });
            DB.save(); UI.updateNav(); this.notify("Uploaded for review.");
        });
    },

    adminUploadWithPreviewFromCreate: function(){
        if(!this.user || !this.user.isAdmin) return this.notify("Admin only","error");
        const type = document.getElementById('adm-up-type-create').value;
        const name = document.getElementById('adm-up-name-create').value.trim();
        const url = document.getElementById('adm-up-url-create').value.trim();
        const price = parseInt(document.getElementById('adm-up-price-create').value) || 0;
        if(!name || !url) return this.notify("Missing details","error");

        UI.showAssetPreview(type, url, name, price, (confirmed) => {
            if(!confirmed) return this.notify("Upload cancelled");
            const item = { id: Date.now(), type:type, name:name, creator:'BlockVerse', price:price, url:url, approved:true, madeBy:'BlockVerse' };
            DB.catalog.push(item); DB.save(); this.notify('Official Item Created');
            UI.renderCatalog(type); UI.renderAvatarEditor(); UI.renderCreate(); UI.renderHome();
        });
    },

    updateBio: function(){ this.user.bio = document.getElementById('prof-desc-input').value; DB.save(); Router.viewProfile(this.user.username); },
    banUser: function(){ const target = DB.users.find(u => u.username === document.getElementById('prof-name').innerText); if(target){ target.banned = true; DB.save(); this.notify("User Banned"); } },
    giveCurrency: function(){ const target = DB.users.find(u => u.username === document.getElementById('prof-name').innerText); if(target){ target.currency += 1000; DB.save(); this.notify('Gift sent'); } },

    deleteUser: function(username){ if(!this.user || !this.user.isAdmin) return this.notify("No access","error"); DB.users = DB.users.filter(u=>u.username !== username); DB.save(); API.notify('User deleted'); },

    exportJSON: function(gameId){
        if(!this.user) return this.notify("No access","error");
        const g = DB.games.find(x => x.id === gameId);
        if(!g) return this.notify("Game not found","error");
        const dataText = JSON.stringify(g, null, 2);
        UI.showModal("Export .blockverse (copy & save)", `<p style="color:var(--text-muted)">Copy the JSON below and save it as <strong>yourgame.blockverse</strong></p><pre style="white-space:pre-wrap; max-height:60vh; overflow:auto;">${escapeHtml(dataText)}</pre>`);
    },

    importJSONToLibrary: function(jsonText){
        try{
            const g = JSON.parse(jsonText);
            if(!g || !g.name) return this.notify("Invalid game file","error");
            g.id = Date.now();
            DB.games.push(g); DB.save();
            this.notify("Game imported");
            UI.renderCreate();
        } catch(e){
            this.notify("Failed to parse file","error");
        }
    },

    exportAllDataForAdmin: function(){
        if(!this.user || !this.user.isAdmin) return;
        const data = JSON.stringify({ DB }, null, 2);
        UI.showModal("Export JSON", `<pre style="white-space:pre-wrap; max-height:60vh; overflow:auto;">${escapeHtml(data)}</pre>`);
    },

    deleteAll: function(){ if(!this.user || !this.user.isAdmin) return this.notify("No access","error"); if(!confirm("Delete EVERYTHING? This cannot be undone.")) return; 
        DB.users=[]; DB.games=[]; DB.catalog=[]; DB.save(); location.reload(); 
    },

    claimDaily: function(){
        const now = Date.now();
        const last = this.user.lastDaily || 0;
        if(now - last >= 24*60*60*1000){
            this.user.currency = (this.user.currency || 0) + 5;
            this.user.lastDaily = now;
            DB.save();
            UI.updateNav();
            UI.showDailyClaimedModal(5);
        } else this.notify("Daily not ready","error");
    },

    sendMessage: function(){
        const to = document.getElementById('msg-recipient').value.trim();
        const content = document.getElementById('msg-content').value.trim();
        if(!to || !content) return this.notify('Missing fields','error');
        if(!DB.users.find(u => u.username === to)) return this.notify('User not found','error');
        DB.messages.push({ id: Date.now(), type:'message', from:this.user.username, to, content, time: new Date().toLocaleString(), flagged:false });
        DB.save(); UI.renderInbox(); this.notify('Message sent');
        document.getElementById('msg-content').value = '';
    },

    showAccountSettings: function(){ document.getElementById('account-settings').style.display = 'flex'; },
    saveAccountSettings: function(){ const email = document.getElementById('acct-email').value; const pwd = document.getElementById('acct-password').value; if(email) this.user.email = btoa(email); if(pwd) this.user.password = pwd; DB.save(); this.notify("Saved"); document.getElementById('account-settings').style.display = 'none'; },

    applyAvatarToMesh: function(user, mesh){
        try{
            const torso = mesh.getObjectByName('torso') || mesh.children.find(c => c.position && c.position.y > 0.4 && c.position.y < 1.6);
            const head = mesh.getObjectByName('head') || mesh.children.find(c => c.position && c.position.y > 1.4);
            const lLeg = mesh.getObjectByName('lLeg') || mesh.children.find(c => c.position && c.position.y < 0);
            const rLeg = mesh.getObjectByName('rLeg') || null;

            if(torso){
                if(!torso.material) torso.material = new THREE.MeshLambertMaterial({ color: user.avatar.shirtColor });
                torso.material.color.set(user.avatar.shirtColor || '#3b82f6');
                if(user.avatar.shirt){
                    const it = DB.catalog.find(i=>i.id===user.avatar.shirt);
                    if(it && it.url){
                        new THREE.TextureLoader().load(it.url, t => { torso.material.map = t; torso.material.needsUpdate = true; });
                    } else { torso.material.map = null; torso.material.needsUpdate = true; }
                } else { torso.material.map = null; torso.material.needsUpdate = true; }
            }
            if(lLeg){
                if(!lLeg.material) lLeg.material = new THREE.MeshLambertMaterial({ color: user.avatar.pantsColor });
                lLeg.material.color.set(user.avatar.pantsColor || '#1e293b');
                if(user.avatar.pants){
                    const it = DB.catalog.find(i=>i.id===user.avatar.pants);
                    if(it && it.url){
                        new THREE.TextureLoader().load(it.url, t => { lLeg.material.map = t; lLeg.material.needsUpdate = true; });
                    } else { lLeg.material.map = null; lLeg.material.needsUpdate = true; }
                } else { lLeg.material.map = null; lLeg.material.needsUpdate = true; }
            }
            if(head){
                if(!head.material) head.material = new THREE.MeshLambertMaterial({ color: user.avatar.body });
                head.material.color.set(user.avatar.body || '#cdcdcd');
                if(user.avatar.face){
                    const it = DB.catalog.find(i=>i.id===user.avatar.face);
                    if(it && it.url){
                        new THREE.TextureLoader().load(it.url, t => { head.material.map = t; head.material.needsUpdate = true; });
                    } else { head.material.map = null; head.material.needsUpdate = true; }
                } else { head.material.map = null; head.material.needsUpdate = true; }
            }

            const existingHat = mesh.getObjectByName('user-hat');
            if(existingHat) existingHat.parent.remove(existingHat);
            if(user.avatar.hat){
                const it = DB.catalog.find(i=>i.id===user.avatar.hat);
                const hatGeom = new THREE.BoxGeometry(0.9,0.2,0.9);
                if(it && it.url){
                    new THREE.TextureLoader().load(it.url, t => {
                        const hatMat = new THREE.MeshLambertMaterial({ map: t });
                        const hat = new THREE.Mesh(hatGeom, hatMat); hat.name = 'user-hat'; hat.position.y = 2.4; mesh.add(hat);
                    });
                } else {
                    const hat = new THREE.Mesh(hatGeom, new THREE.MeshLambertMaterial({ color:0x111111 })); hat.name='user-hat'; hat.position.y=2.4; mesh.add(hat);
                }
            }
        }catch(e){ console.warn('applyAvatarToMesh error', e); }
    }
};

function escapeHtml(unsafe){ return unsafe.replace(/[&<"'>]/g, function(m){ return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;', "'": '&#039;'}[m]); }); }

/* ========================================================================== 
   ROUTER & UI
   ========================================================================== */
let currentViewingGameId = null;

const Router = {
    go: function(pageId){
        document.querySelectorAll('.container').forEach(c => c.classList.remove('active'));
        document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
        const target = document.getElementById('page-' + pageId);
        if(target) target.classList.add('active');
        const nav = document.getElementById('nav-' + pageId);
        if(nav) nav.classList.add('active');
        if(pageId === 'home') UI.renderHome();
        if(pageId === 'games') UI.renderGames();
        if(pageId === 'catalog') UI.renderCatalog('shirt');
        if(pageId === 'create') UI.renderCreate();
        if(pageId === 'users') UI.renderUsers();
        if(pageId === 'avatar') UI.renderAvatarEditor();
        if(pageId === 'inbox') UI.renderInbox();
    },

    viewProfile: function(username){
        const user = DB.users.find(u => u.username === username);
        if(!user) return;
        this.go('profile');
        const isMe = (user.username === API.user.username);

        document.getElementById('prof-name').innerText = user.username;
        document.getElementById('prof-date').innerText = user.joined;
        document.getElementById('prof-status').innerText = user.banned ? "BANNED" : (user.online ? 'Online' : 'Offline');
        document.getElementById('prof-status').style.color = user.banned ? "red" : (user.online ? "var(--success)" : "gray");
        document.getElementById('prof-desc').innerText = user.bio || "No description.";
        document.getElementById('prof-desc-input').value = user.bio || "";

        document.getElementById('prof-edit-desc').classList.toggle('hidden', !isMe);
        document.getElementById('profile-settings-btn').style.display = isMe ? 'block' : 'none';
        document.getElementById('admin-actions').classList.toggle('hidden', !API.user.isAdmin || isMe);

        document.getElementById('prof-title').innerText = user.title ? `‚Ä¢ ${user.title}` : '';

        const friendBtnContainer = document.getElementById('prof-friend-btn');
        friendBtnContainer.innerHTML = '';
        if(!isMe){
            const isFriend = API.user.friends.includes(user.username);
            const btn = document.createElement('button');
            btn.className = 'btn btn-sm ' + (isFriend ? 'btn-outline' : 'btn-primary');
            btn.innerText = isFriend ? 'Unfriend' : 'Add Friend';
            btn.onclick = () => {
                if(isFriend) {
                    API.user.friends = API.user.friends.filter(f => f !== user.username);
                    const other = DB.users.find(u=>u.username===user.username);
                    if(other) other.friends = other.friends.filter(f => f !== API.user.username);
                    DB.save(); API.notify('Unfriended'); UI.renderHome(); Router.viewProfile(user.username);
                } else {
                    API.sendFriendRequest(user.username);
                }
            };
            friendBtnContainer.appendChild(btn);
        }

        const grid = document.getElementById('prof-inventory');
        grid.innerHTML = user.inventory.map(id => {
            const item = DB.catalog.find(i => i.id === id);
            return item ? `<div class="card" style="padding:10px;font-size:12px;text-align:center;">${item.name}</div>` : '';
        }).join('');

        setTimeout(()=>AvatarRenderer.render(user, 'profile-avatar-view'), 50);
    },

    viewGame: function(gameId){
        const g = DB.games.find(x => x.id === gameId);
        if(!g) return API.notify('Game not found','error');
        currentViewingGameId = gameId;
        this.go('game');
        document.getElementById('game-title').innerText = g.name;
        document.getElementById('game-creator').innerText = g.creator;
        document.getElementById('game-creator').onclick = () => Router.viewProfile(g.creator);
        document.getElementById('game-desc').innerText = g.description || 'No description.';
        document.getElementById('game-players-count').innerText = (g._session && g._session.players ? g._session.players.length : 0);
        document.getElementById('game-thumbnail').style.background = g.thumbnailColor || '#333';
        document.getElementById('game-thumbnail').innerHTML = g.thumbnailUrl ? `<img src="${g.thumbnailUrl}" style="max-width:100%; max-height:100%; border-radius:12px;">` : '';

        const comments = g.comments || [];
        document.getElementById('comment-list').innerHTML = comments.map(c => `
            <div style="padding:12px;background:rgba(0,0,0,0.2);border-radius:8px;">
                <div style="font-weight:bold;font-size:12px;margin-bottom:4px;">${c.author} <span style="font-weight:normal;color:#666;float:right">${c.time}</span></div>
                <div style="font-size:13px;">${c.text}</div>
            </div>
        `).join('');

        document.getElementById('game-play-btn').onclick = () => Engine.launch(gameId, false);
        const canConfig = API.user.isAdmin || (API.user.username === g.creator);
        document.getElementById('game-config-btn').style.display = canConfig ? 'block' : 'none';
        document.getElementById('game-config-btn').onclick = () => UI.openGameConfig(gameId);
        const rating = g.votes ? Object.values(g.votes).reduce((a,b)=>a+b,0) : 0;
        document.getElementById('game-rating').innerText = rating > 0 ? "+"+rating : rating;
    }
};

const UI = {
    init: function(){
        document.getElementById('page-auth').classList.remove('active');
        document.getElementById('navbar').classList.remove('hidden');
        this.updateNav();
        Router.go('home');
        if(API.user.isAdmin){
            document.getElementById('admin-upload-panel-create').classList.remove('hidden');
            document.getElementById('admin-plus').style.display = 'flex';
        }

        this._currencyTooltipInterval = setInterval(()=>{ if(document.getElementById('currency-tooltip').style.display === 'block') this.updateCurrencyTooltip(); }, 1000);

        const badge = document.getElementById('nav-currency-badge');
        const tip = document.getElementById('currency-tooltip');
        let over = false;
        badge.addEventListener('mouseenter', ()=>{ this.showCurrencyTooltip(); over = true; tip.dataset.manual = '1'; });
        badge.addEventListener('mouseleave', ()=>{ over=false; setTimeout(()=>{ if(!over && !tip.matches(':hover')) this.hideCurrencyTooltip(); }, 120); tip.dataset.manual=''; });
        tip.addEventListener('mouseenter', ()=>{ over = true; tip.dataset.manual='1'; });
        tip.addEventListener('mouseleave', ()=>{ over=false; setTimeout(()=>{ if(!over) this.hideCurrencyTooltip(); }, 120); tip.dataset.manual=''; });
        tip.addEventListener('click', ()=>{ if(tip.dataset.canclaim === '1') { API.claimDaily(); } });

        this.renderCreatorCatalog();
    },

    updateNav: function(){ document.getElementById('nav-username').innerText = API.user.username; document.getElementById('nav-currency').innerText = API.user.currency || 0; },

    showCurrencyTooltip: function(){
        const tip = document.getElementById('currency-tooltip');
        const last = API.user.lastDaily || 0;
        const next = last + 24*60*60*1000;
        const now = Date.now();
        if(now >= next) { this.showDailyClaimModal(); tip.dataset.canclaim = '1'; }
        else { tip.dataset.canclaim='0'; tip.style.display='block'; this.updateCurrencyTooltip(); }
    },

    hideCurrencyTooltip: function(){ document.getElementById('currency-tooltip').style.display='none'; },

    updateCurrencyTooltip: function(){
        const tip = document.getElementById('currency-tooltip');
        const last = API.user.lastDaily || 0;
        const next = last + 24*60*60*1000;
        const now = Date.now();
        if(now >= next){ tip.innerHTML = `Daily available now ‚Äî Click to claim`; tip.dataset.canclaim='1'; } else {
            const ms = next - now;
            const hh = Math.floor(ms / (1000*60*60));
            const mm = Math.floor((ms % (1000*60*60)) / (1000*60));
            const ss = Math.floor((ms % (1000*60)) / 1000);
            tip.innerText = `Next daily in ${hh}h ${mm}m ${ss}s`;
            tip.dataset.canclaim='0';
        }
    },

    showDailyClaimModal: function(){
        const modal = document.getElementById('daily-modal');
        const content = document.getElementById('daily-modal-content');
        content.innerHTML = `<h3>Daily Reward</h3><p style="color:var(--text-muted)">A daily bonus of <strong>+5</strong> currency is available.</p><div style="display:flex;gap:10px;justify-content:flex-end;margin-top:12px;"><button class="btn btn-outline" onclick="document.getElementById('daily-modal').style.display='none'">Close</button><button class="btn btn-primary" onclick="API.claimDaily(); document.getElementById('daily-modal').style.display='none'">Claim +5</button></div>`;
        modal.style.display = 'flex';
    },

    showDailyClaimedModal: function(amount){
        const modal = document.getElementById('daily-modal');
        const content = document.getElementById('daily-modal-content');
        content.innerHTML = `<h3>Received</h3><p style="color:var(--text-muted)">You have received your daily <strong>${amount}</strong> currency.</p><div style="display:flex;gap:10px;justify-content:flex-end;margin-top:12px;"><button class="btn btn-primary" onclick="document.getElementById('daily-modal').style.display='none'">Close</button></div>`;
        modal.style.display = 'flex';
        API.notify(`+${amount} currency received`);
    },

    showAssetPreview: function(type, url, name, price, callback){
        const modal = document.getElementById('asset-preview-modal');
        const content = document.getElementById('asset-preview-content');
        content.innerHTML = `<h3>Preview Upload</h3><div id="asset-preview-canvas" style="width:100%;height:260px;background:#000;border-radius:8px;margin-bottom:12px;overflow:hidden"></div><div style="font-size:13px;color:var(--text-muted);">Item: <strong>${escapeHtml(name)}</strong> ‚Äî Type: <strong>${escapeHtml(type)}</strong> ‚Äî Price: <strong>${price}</strong></div><div style="display:flex;gap:10px;justify-content:flex-end;margin-top:12px;"><button class="btn btn-outline" id="asset-preview-no">Cancel</button><button class="btn btn-primary" id="asset-preview-ok">OK - Upload</button></div>`;
        modal.style.display = 'flex';

        const dv = document.getElementById('asset-preview-canvas'); dv.innerHTML = '';
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(45, dv.clientWidth/dv.clientHeight, 0.1, 100);
        camera.position.set(0,1.7,3);
        const renderer = new THREE.WebGLRenderer({ alpha:true, antialias:true });
        renderer.setSize(dv.clientWidth, dv.clientHeight);
        dv.appendChild(renderer.domElement);
        const light = new THREE.DirectionalLight(0xffffff,1.2); light.position.set(2,5,5);
        scene.add(light); scene.add(new THREE.AmbientLight(0x555555));
        const group = new THREE.Group();

        const matBody = new THREE.MeshLambertMaterial({ color:0xcccccc });
        const matTorso = new THREE.MeshLambertMaterial({ color:0x3b82f6 });
        const matPants = new THREE.MeshLambertMaterial({ color:0x1e293b });

        const torso = new THREE.Mesh(new THREE.BoxGeometry(1.2, 1.4, 0.65), matTorso); torso.name = 'torso'; torso.position.y = 1.0;
        const head = new THREE.Mesh(new THREE.BoxGeometry(0.65, 0.65, 0.65), matBody); head.name = 'head'; head.position.y = 2.025;
        const lArm = new THREE.Mesh(new THREE.BoxGeometry(0.625, 1.3, 0.625), matBody); lArm.name = 'lArm'; lArm.position.set(-0.92, 1.05, 0);
        const rArm = new THREE.Mesh(new THREE.BoxGeometry(0.625, 1.3, 0.625), matBody); rArm.name = 'rArm'; rArm.position.set(0.92, 1.05, 0);
        const lLeg = new THREE.Mesh(new THREE.BoxGeometry(0.625, 1.3, 0.625), matPants); lLeg.name='lLeg'; lLeg.position.set(-0.3, -0.35, 0);
        const rLeg = new THREE.Mesh(new THREE.BoxGeometry(0.625, 1.3, 0.625), matPants); rLeg.name='rLeg'; rLeg.position.set(0.3, -0.35, 0);

        group.add(torso); group.add(head); group.add(lArm); group.add(rArm); group.add(lLeg); group.add(rLeg);
        scene.add(group);

        if(type === 'shirt' || type === 'pants' || type === 'face' || type === 'hat'){
            new THREE.TextureLoader().load(url, tex => {
                tex.flipY = false;
                if(type === 'shirt'){ matTorso.map = tex; matTorso.needsUpdate = true; }
                if(type === 'pants'){ matPants.map = tex; matPants.needsUpdate = true; }
                if(type === 'face'){ head.material = head.material || new THREE.MeshLambertMaterial({ color:0xcccccc }); head.material.map = tex; head.material.needsUpdate = true; }
                if(type === 'hat'){ const hat = new THREE.Mesh(new THREE.BoxGeometry(0.8,0.18,0.8), new THREE.MeshLambertMaterial({ map: tex })); hat.position.y = 1.95; group.add(hat); }
            }, undefined, () => { console.warn('Preview image failed to load:', url); });
        } else if(type === 'audio'){
            const txt = document.createElement('div'); txt.style.position='absolute'; txt.style.left='12px'; txt.style.top='12px'; txt.style.color='white'; txt.innerText='Audio Preview: ' + name; dv.appendChild(txt);
        }

        function anim(){ requestAnimationFrame(anim); group.rotation.y += 0.01; renderer.render(scene, camera); }
        anim();

        document.getElementById('asset-preview-no').onclick = ()=>{ modal.style.display='none'; renderer.dispose && renderer.dispose(); callback(false); };
        document.getElementById('asset-preview-ok').onclick = ()=>{ modal.style.display='none'; renderer.dispose && renderer.dispose(); callback(true); };
    },

    showModal: function(title, html){
        const c = document.createElement('div');
        c.className = 'modal-overlay';
        c.style.display = 'flex';
        c.innerHTML = `<div class="modal-content"><h3>${title}</h3>${html}<div style="margin-top:12px;text-align:right"><button class="btn btn-outline" onclick="this.closest('.modal-overlay').remove()">Close</button></div></div>`;
        document.body.appendChild(c);
    },

    renderHome: function(){
        document.getElementById('home-welcome').innerText = "Hi, " + API.user.username;
        document.getElementById('home-join-date').innerText = API.user.joined;
        setTimeout(()=>AvatarRenderer.render(API.user, 'home-avatar-view'), 50);
        const grid = document.getElementById('home-rec-games');
        grid.innerHTML = DB.games.filter(g => g.public).slice(0,4).map(g => this.gameCard(g)).join('') || '<div style="color:#666;padding:20px;">No games available. Create one!</div>';
        this.renderFriendsBar();
    },

    renderFriendsBar: function(){
        const container = document.getElementById('home-friends-container');
        const friends = (API.user.friends || []).map(n => DB.users.find(u => u.username === n)).filter(Boolean);
        if(friends.length === 0){
            container.innerHTML = `<div style="font-size:12px;color:var(--text-muted);margin-top:8px;">No friends yet ‚Äî add some from profiles.</div>`;
            return;
        }
        container.innerHTML = `<div style="font-size:12px;color:var(--text-muted);margin-bottom:6px;">Friends</div><div class="friends-row">${friends.map(f => `<div class="friend-pill" onclick="Router.viewProfile('${f.username}')"><div style="width:28px;height:28px;border-radius:50%;background:${f.avatar.body};display:flex;align-items:center;justify-content:center;color:#000;font-weight:700">${f.username[0].toUpperCase()}</div><div>${f.username}</div></div>`).join('')}</div>`;
    },

    searchGames: function(q){
        const list = DB.games.filter(g => g.public && (g.name.toLowerCase().includes(q.toLowerCase()) || g.creator.toLowerCase().includes(q.toLowerCase())));
        document.getElementById('games-list').innerHTML = list.map(g => this.gameCard(g)).join('');
    },

    renderGames: function(){ const grid = document.getElementById('games-list'); grid.innerHTML = DB.games.filter(g=>g.public).map(g => this.gameCard(g)).join(''); },

    gameCard: function(g){
        return `<div class="card" style="padding:15px;cursor:pointer;transition:transform .2s;" onmouseover="this.style.transform='translateY(-5px)'" onmouseout="this.style.transform='translateY(0)'" onclick="Router.viewGame(${g.id})"><div style="height:140px;background:${g.thumbnailColor || '#333'};border-radius:8px;margin-bottom:15px;display:flex;align-items:center;justify-content:center;overflow:hidden;">${g.thumbnailUrl ? `<img src="${g.thumbnailUrl}" style="width:100%;height:100%;object-fit:cover">` : '<div style="opacity:0.3;font-weight:900;letter-spacing:2px;">VERSE</div>'}</div><h4 style="margin:0 0 5px 0;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${g.name}</h4><div style="font-size:12px;color:var(--text-muted);">by ${g.creator}</div></div>`;
    },

    renderCatalog: function(category){
        const grid = document.getElementById('catalog-grid');
        const items = DB.catalog.filter(i=>i.type === category && i.approved);
        grid.innerHTML = items.map(i => {
            const owned = API.user.inventory.includes(i.id);
            const equipped = (API.user.avatar[i.type] === i.id);
            return `<div class="card" style="padding:15px;text-align:center;"><div style="height:80px;background:rgba(0,0,0,0.3);border-radius:8px;margin-bottom:10px;display:flex;align-items:center;justify-content:center;">${i.name.substring(0,2)}</div><h4 style="margin:0 0 5px 0;font-size:14px;">${i.name}</h4><div style="color:gold;font-size:12px;font-weight:bold;margin-bottom:10px;">${i.price} Coins</div><button class="btn btn-sm ${owned ? 'btn-outline' : 'btn-success'}" style="width:100%" onclick="API.buyItem(${i.id})">${owned ? (equipped ? 'Unequip' : 'Equip') : 'Buy'}</button></div>`;
        }).join('');
    },

    renderCreate: function(){
        const grid = document.getElementById('my-games-list');
        const myGames = DB.games.filter(g => g.creator === API.user.username);
        grid.innerHTML = myGames.map(g => `
            <div class="card" style="padding:15px;">
                <h4 style="margin:0 0 5px 0;">${g.name}</h4>
                <div style="font-size:11px;color:#888;margin-bottom:10px;">${g.public ? 'Public' : 'Private'}</div>
                <div style="display:flex;gap:10px;">
                    <button class="btn btn-primary btn-sm" onclick="Engine.launch(${g.id}, true)">Edit</button>
                    <button class="btn btn-outline btn-sm" onclick="UI.openGameConfig(${g.id})">Config</button>
                    <button class="btn btn-outline btn-sm" onclick="API.exportJSON(${g.id})">Export</button>
                </div>
            </div>
        `).join('') || '<div style="color:#666">You haven\'t created any games.</div>';
        this.renderCreatorCatalog();
    },

    renderCreatorCatalog: function(){
        const c = document.getElementById('creator-catalog');
        c.innerHTML = DB.catalog.map(i => `<div style="padding:8px;border-radius:8px;background:rgba(255,255,255,0.02);margin-bottom:6px;display:flex;justify-content:space-between;align-items:center;"><div><strong style="font-size:13px">${i.name}</strong><div style="font-size:11px;color:var(--text-muted)">${i.type} ‚Äî ${i.creator}</div></div><div><button class="btn btn-sm btn-primary" onclick="UI.insertCatalogIntoStudio(${i.id})">Use</button></div></div>`).join('');
    },

    insertCatalogIntoStudio: function(itemId){
        const item = DB.catalog.find(x=>x.id===itemId);
        if(!item) return API.notify("Item not found","error");
        if(!Engine.selectedStudioObj) return API.notify("Select an object in Studio","error");
        if(item.type === 'audio'){
            Engine.selectedStudioObj.userData.audio = { url: item.url, price: item.price, creator:item.creator };
            API.notify('Audio attached to selected part');
        } else {
            Engine.selectedStudioObj.userData.asset = { id:item.id, type:item.type, url:item.url };
            API.notify('Asset attached to selected part');
        }
        Studio.saveLocal();
    },

    openImportModal: function(){
        const html = `<h3>Import .blockverse</h3><p style="color:var(--text-muted)">Paste the JSON content of your exported game file below and click Import.</p><textarea id="import-json" rows="12" style="width:100%;"></textarea><div style="display:flex;justify-content:flex-end;margin-top:12px;"><button class="btn btn-outline" onclick="document.querySelector('.modal-overlay').remove()">Close</button><button class="btn btn-primary" style="margin-left:8px;" onclick="UI.performImport()">Import</button></div>`;
        UI.showModal('Import .blockverse', html);
    },

    performImport: function(){
        const ta = document.getElementById('import-json');
        if(!ta) return;
        const val = ta.value.trim();
        if(!val) return API.notify('Paste a file first','error');
        try{ const g = JSON.parse(val); if(!g || !g.name) return API.notify('Invalid file','error'); API.importJSONToLibrary(val); document.querySelector('.modal-overlay').remove(); } catch(e){ API.notify('Failed to parse file','error'); }
    },

    renderUsers: function(){
        const list = document.getElementById('users-list');
        list.innerHTML = DB.users.map(u => `
            <div class="user-row" onclick="Router.viewProfile('${u.username}')">
                <div class="user-avatar-small" style="background:${u.avatar.body};display:flex;align-items:center;justify-content:center;color:#000;font-weight:bold">${u.username[0].toUpperCase()}</div>
                <div><div style="font-weight:600;">${u.username} ${u.isAdmin ? '<span style="color:var(--danger);font-size:10px;margin-left:5px;">ADMIN</span>' : ''} ${u.title ? '<span style="color:var(--accent);font-size:10px;margin-left:5px;">'+u.title+'</span>' : ''}</div><div style="font-size:12px;color:var(--text-muted);">${u.bio?u.bio.substring(0,50):''}</div></div>
            </div>
        `).join('');
    },

    filterUsers: function(q){ document.querySelectorAll('.user-row').forEach(row => { row.style.display = row.innerText.toLowerCase().includes(q.toLowerCase()) ? 'flex' : 'none'; }); },

    renderAvatarEditor: function(){
        document.getElementById('avatar-head').value = API.user.avatar.body;
        document.getElementById('avatar-torso').value = API.user.avatar.shirtColor;
        document.getElementById('avatar-legs').value = API.user.avatar.pantsColor;
        setTimeout(()=>AvatarRenderer.render(API.user, 'avatar-edit-view'), 50);
        const grid = document.getElementById('avatar-inventory');
        const items = API.user.inventory.map(id => DB.catalog.find(i=>i.id===id)).filter(Boolean);
        grid.innerHTML = items.map(i => {
            const equipped = (API.user.avatar[i.type] === i.id);
            return `<div class="card" style="padding:10px;text-align:center;${equipped ? 'border-color:var(--primary);box-shadow:0 0 10px rgba(59,130,246,0.3);' : ''}" onclick="API.buyItem(${i.id}); UI.renderAvatarEditor()"><div style="font-size:12px;margin-bottom:5px;">${i.name}</div><div style="font-size:10px;color:#888;">${i.type.toUpperCase()}</div></div>`;
        }).join('');
    },

    saveAvatar: function(){
        API.user.avatar.body = document.getElementById('avatar-head').value;
        API.user.avatar.shirtColor = document.getElementById('avatar-torso').value;
        API.user.avatar.pantsColor = document.getElementById('avatar-legs').value;
        DB.save(); API.notify('Character Saved');
        AvatarRenderer.render(API.user, 'avatar-edit-view');
        if(Engine.players && Engine.players.length > 0){
            const pls = Engine.players.filter(p => p.username === API.user.username);
            pls.forEach(p => API.applyAvatarToMesh(API.user, p.mesh));
        }
    },

    renderInbox: function(){
        const list = document.getElementById('inbox-list');
        const msgs = DB.messages.filter(m => m.to === API.user.username || m.from === API.user.username).sort((a,b)=>b.id-a.id);
        list.innerHTML = msgs.map(m => {
            const preview = m.type === 'friend_request' ? `${m.from} wants to be friends` : (m.content ? m.content.substring(0,20)+'...' : m.note || '');
            return `<div class="user-row" onclick="UI.viewMessage(${m.id})"><div style="flex:1;"><div style="font-weight:bold;font-size:12px;">${m.type === 'friend_request' ? 'Friend Request' : (m.from === API.user.username ? 'To: '+m.to : 'From: '+m.from)}</div><div style="font-size:11px;color:#888;">${preview}</div></div></div>`;
        }).join('') || '<div style="padding:10px;color:#666;font-size:12px;">No messages</div>';
    },

    viewMessage: function(id){
        const m = DB.messages.find(x => x.id === id);
        if(!m) return;
        const inboxView = document.getElementById('inbox-view');
        if(m.type === 'friend_request'){
            inboxView.innerHTML = `<div style="padding:20px;"><h3>Friend Request</h3><div style="color:var(--text-muted);margin-bottom:12px;">${m.from} has sent you a friend request.</div><div style="display:flex;gap:10px;justify-content:flex-end;"><button class="btn btn-outline" onclick="API.respondFriendRequest(${m.id}, false)">Decline</button><button class="btn btn-primary" onclick="API.respondFriendRequest(${m.id}, true)">Accept</button></div></div>`;
        } else {
            inboxView.innerHTML = `<div style="padding:20px;"><h3>${m.from} ‚Üí ${m.to}</h3><div style="color:#888;font-size:12px;margin-bottom:20px;">${m.time}</div><div style="background:rgba(255,255,255,0.05);padding:20px;border-radius:10px;">${m.content || m.note || ''}</div></div>`;
        }
    },

    rateGame: function(gameId, val){
        const g = DB.games.find(x=>x.id===gameId);
        if(!g) return;
        g.votes = g.votes || {};
        if(g.votes[API.user.username]) return API.notify('Already voted','error');
        g.votes[API.user.username] = val; DB.save();
        document.getElementById('game-rating').innerText = Object.values(g.votes).reduce((a,b)=>a+b,0);
    },

    postComment: function(gameId){
        const txt = document.getElementById('comment-text').value.trim();
        if(!txt) return;
        const g = DB.games.find(x=>x.id===gameId);
        g.comments = g.comments || [];
        g.comments.push({ id: Date.now(), author: API.user.username, text: txt, time: new Date().toLocaleString()});
        DB.save(); Router.viewGame(gameId);
        document.getElementById('comment-text').value = '';
    },

    toggleAdminModal: function(){
        const modal = document.getElementById('admin-modal');
        const content = document.getElementById('admin-modal-content');
        if(modal.style.display === 'flex'){ modal.style.display = 'none'; } else {
            content.innerHTML = `<h2 style="margin-top:0;">Admin Control</h2><div style="display:flex;gap:20px;"><div style="flex:1;"><h4>Users</h4><input id="admin-user-target" placeholder="Username"><div style="display:flex;gap:5px;flex-wrap:wrap;"><button class="btn btn-sm btn-danger" onclick="Admin.banUser()">Ban</button><button class="btn btn-sm btn-success" onclick="Admin.unbanUser()">Unban</button><button class="btn btn-sm btn-primary" onclick="Admin.addAdmin()">Promote</button><button class="btn btn-sm btn-danger" onclick="Admin.deleteUser()">Delete User</button></div><hr style="border:0;border-top:1px solid var(--border);margin:15px 0;"><h4>System</h4><button class="btn btn-sm btn-danger" style="width:100%" onclick="Admin.purgeSite()">INITIATE PURGE</button><button class="btn btn-sm btn-outline" style="width:100%;margin-top:5px;" onclick="Admin.unPurgeSite()">Disable Purge</button><button class="btn btn-sm btn-danger" style="width:100%;margin-top:8px;" onclick="Admin.deleteAll()">Delete EVERYTHING</button><button class="btn btn-sm btn-primary" style="width:100%;margin-top:8px;" onclick="Admin.exportJSON()">Export JSON</button></div><div style="flex:1;border-left:1px solid var(--border);padding-left:20px;"><h4>Moderation Queue</h4><div id="admin-moderation" style="max-height:300px;overflow-y:auto;"></div></div></div><div style="text-align:right;margin-top:20px;"><button class="btn btn-outline" onclick="UI.toggleAdminModal()">Close</button></div>`;
            Admin.renderModeration();
            modal.style.display = 'flex';
        }
    },

    openGameConfig: function(id){
        const g = DB.games.find(x=>x.id===id);
        if(!g) return;
        window._editingGameId = id;
        document.getElementById('cfg-name').value = g.name;
        document.getElementById('cfg-desc').value = g.description;
        document.getElementById('cfg-thumb').value = g.thumbnailColor || '#333333';
        document.getElementById('game-config-modal').style.display = 'flex';
    },

    closeGameConfig: function(){ document.getElementById('game-config-modal').style.display = 'none'; },

    saveGameConfig: function(){
        const id = window._editingGameId;
        const g = DB.games.find(x=>x.id===id);
        g.name = document.getElementById('cfg-name').value;
        g.description = document.getElementById('cfg-desc').value;
        g.thumbnailColor = document.getElementById('cfg-thumb').value;
        DB.save(); API.notify('Saved'); UI.closeGameConfig(); Router.viewGame(id);
    }
};

/* ========================================================================== 
   ADMIN helpers
   ========================================================================== */
const Admin = {
    getUser: () => document.getElementById('admin-user-target') ? document.getElementById('admin-user-target').value.trim() : '',
    banUser: function(){ const u = DB.users.find(x=>x.username===this.getUser()); if(u){ u.banned=true; DB.save(); API.notify('Banned'); Admin.renderModeration(); } },
    unbanUser: function(){ const u = DB.users.find(x=>x.username===this.getUser()); if(u){ u.banned=false; DB.save(); API.notify('Unbanned'); Admin.renderModeration(); } },
    addAdmin: function(){ const u = DB.users.find(x=>x.username===this.getUser()); if(u){ u.isAdmin=true; DB.save(); API.notify('Promoted'); Admin.renderModeration(); } },
    deleteUser: function(){ const u = DB.users.find(x=>x.username===this.getUser()); if(!u) return API.notify('User not found','error'); if(!confirm('Delete user '+u.username+'?')) return; DB.users = DB.users.filter(x=>x.username!==u.username); DB.save(); API.notify('User deleted'); Admin.renderModeration(); },
    purgeSite: function(){ DB.sitePurged = true; DB.save(); document.getElementById('overlay-purged').style.display = 'flex'; },
    unPurgeSite: function(){ DB.sitePurged = false; DB.save(); document.getElementById('overlay-purged').style.display = 'none'; },
    exportJSON: function(){ if(!API.user || !API.user.isAdmin) return; API.exportAllDataForAdmin(); },
    deleteAll: function(){ API.deleteAll(); },

    renderModeration: function(){
        const div = document.getElementById('admin-moderation');
        div.innerHTML = DB.moderation.map(m => `<div style="background:rgba(0,0,0,0.2);padding:10px;border-radius:8px;margin-bottom:5px;font-size:11px;"><div style="font-weight:bold;color:var(--warning)">${m.type.toUpperCase()}</div><div>${m.reason}</div><div style="margin-top:5px;display:flex;gap:5px;"><button class="btn btn-sm btn-success" onclick="Admin.process(${m.id}, true)">‚úî</button><button class="btn btn-sm btn-danger" onclick="Admin.process(${m.id}, false)">‚úñ</button></div></div>`).join('') || '<div style="color:#666">Queue empty</div>';
    },

    process: function(id, approve){
        const idx = DB.moderation.findIndex(x=>x.id===id);
        if(idx === -1) return;
        const m = DB.moderation[idx];
        if(m.type === 'asset'){
            const item = DB.catalog.find(i=>i.id===m.targetId);
            if(item){
                item.approved = approve;
                if(!approve) DB.catalog = DB.catalog.filter(i=>i.id !== m.targetId);
            }
        }
        DB.moderation.splice(idx,1); DB.save(); this.renderModeration();
    }
};

/* ========================================================================== 
   3D Engine (studio + play)
   ========================================================================== */
const Engine = {
    scene:null, camera:null, renderer:null, loopId:null, currentGame:null, mode:'play',
    controls:{ w:false,a:false,s:false,d:false,space:false,q:false,e:false }, objects:[], players:[],
    raycaster: new THREE.Raycaster(), mouse: new THREE.Vector2(), selectedStudioObj:null,
    playCamYaw:0, playCamPitch:-0.3,
    studioState:{
        orbiting:false,panning:false,orbitStart:{x:0,y:0},orbitYaw:0,orbitPitch:0,center:new THREE.Vector3(0,0,0),distance:20,gizmo:null,draggingGizmo:null
    },

    launch: function(gameId, isStudio){
        const game = DB.games.find(g=>g.id===gameId);
        if(!game) return;
        this.currentGame = game; this.mode = isStudio ? 'studio' : 'play';
        document.getElementById('app-viewport').style.display = 'block';
        document.getElementById('studio-ui').style.display = isStudio ? 'flex' : 'none';
        document.getElementById('in-game-menu').classList.toggle('hidden', isStudio);
        if(!this.currentGame._Session) this.currentGame._session = { id: Date.now(), players: [] };
        this.currentGame._session.players = [{ username: API.user.username }];
        this.initThree();
    },

    initThree: function(){
        const vp = document.getElementById('viewport');
        vp.innerHTML = '';
        this.scene = new THREE.Scene();
        this.scene.background = new THREE.Color(0x0f172a);
        this.scene.fog = new THREE.Fog(0x0f172a,20,100);
        this.camera = new THREE.PerspectiveCamera(70, window.innerWidth/window.innerHeight, 0.1, 1000);
        this.camera.position.set(10,10,10);
        this.renderer = new THREE.WebGLRenderer({ antialias:true });
        this.renderer.setSize(window.innerWidth, window.innerHeight);
        this.renderer.shadowMap.enabled = true;
        vp.appendChild(this.renderer.domElement);
        window.onresize = ()=>{ this.renderer.setSize(window.innerWidth, window.innerHeight); this.camera.aspect = window.innerWidth/window.innerHeight; this.camera.updateProjectionMatrix(); };

        const amb = new THREE.AmbientLight(0x404040); this.scene.add(amb);
        const sun = new THREE.DirectionalLight(0xffffff,1); sun.position.set(20,50,20); sun.castShadow = true; this.scene.add(sun);
        const grid = new THREE.GridHelper(200,50,0x334155,0x1e293b); this.scene.add(grid);
        const plate = new THREE.Mesh(new THREE.BoxGeometry(200,1,200), new THREE.MeshLambertMaterial({ color:0x0f172a }));
        plate.position.y = -0.5; plate.receiveShadow = true; this.scene.add(plate); this.objects = [plate];

        if(this.currentGame.mapData){
            this.currentGame.mapData.forEach(data => {
                const pos = new THREE.Vector3(data.pos.x, data.pos.y, data.pos.z);
                const mesh = this.spawnObject(data.type, pos, data.color, data.scale, data.userData);
            });
        }

        this.players = [];
        if(this.mode === 'play'){
            const pObj = this.createPlayerAvatar(API.user);
            const spawn = this.currentGame.mapData?.find(x=>x.type==='spawn');
            if(spawn) pObj.position.set(spawn.pos.x, spawn.pos.y+1, spawn.pos.z);
            else pObj.position.set(0,1,0);
            pObj.userData = { velocityY:0, onGround:true, parts: pObj.userData.parts || {}, health: 100 };
            this.scene.add(pObj); this.players.push({ username: API.user.username, mesh: pObj });
            API.applyAvatarToMesh(API.user, pObj);

            this.renderer.domElement.requestPointerLock = this.renderer.domElement.requestPointerLock || this.renderer.domElement.mozRequestPointerLock;
            this.renderer.domElement.onclick = ()=>{ if(this.mode === 'play') this.renderer.domElement.requestPointerLock(); };

            document.getElementById('health-bar-wrap').style.display = 'flex';
            this.updateHealthHUD( pObj.userData.health );
        } else {
            this.camera.position.set(10,10,10); this.camera.lookAt(0,0,0); this.studioState.distance = this.camera.position.distanceTo(new THREE.Vector3(0,0,0));
            document.getElementById('health-bar-wrap').style.display = 'none';
        }

        this.renderer.domElement.addEventListener('mousedown', (e) => {
            if(this.mode === 'studio'){
                if(e.button === 0) this.onStudioClick(e);
                if(e.button === 1){ this.studioState.panning = true; this.studioState.panStart = { x:e.clientX, y:e.clientY }; }
                if(e.button === 2){ this.studioState.orbiting = true; this.studioState.orbitStart = { x:e.clientX, y:e.clientY }; this.studioState.orbitYaw = this.playCamYaw; this.studioState.orbitPitch = this.playCamPitch; }
            }
        });

        this.renderer.domElement.addEventListener('mousemove', (e) => {
            if(this.mode === 'studio'){
                if(this.studioState.draggingGizmo){ Gizmo.handlePointerMove(e); return; }
                if(this.studioState.orbiting){
                    const dx = (e.clientX - this.studioState.orbitStart.x);
                    const dy = (e.clientY - this.studioState.orbitStart.y);
                    this.playCamYaw = this.studioState.orbitYaw - dx * 0.005;
                    this.playCamPitch = this.studioState.orbitPitch - dy * 0.005;
                    this.playCamPitch = Math.max(-1.2, Math.min(1.2, this.playCamPitch));
                } else if(this.studioState.panning){
                    const dx = (e.clientX - this.studioState.panStart.x) * 0.01;
                    const dy = (e.clientY - this.studioState.panStart.y) * 0.01;
                    this.camera.translateX(-dx);
                    this.camera.translateY(dy);
                    this.studioState.panStart = { x:e.clientX, y:e.clientY };
                }
            }
        });

        this.renderer.domElement.addEventListener('mouseup', (e) => {
            if(this.mode === 'studio'){
                if(e.button === 1) this.studioState.panning = false;
                if(e.button === 2) this.studioState.orbiting = false;
                if(this.studioState.draggingGizmo) Gizmo.handlePointerUp(e);
                this.studioState.draggingGizmo = null;
            }
        });

        this.renderer.domElement.addEventListener('contextmenu', (e) => { if(this.mode==='studio') e.preventDefault(); });

        this.renderer.domElement.addEventListener('wheel', (e) => {
            if(this.mode === 'studio'){ const delta = e.deltaY * 0.01; this.camera.position.add(this.camera.getWorldDirection(new THREE.Vector3()).multiplyScalar(delta)); }
        });

        document.addEventListener('mousemove', (e) => {
            if(document.pointerLockElement === this.renderer.domElement && this.mode === 'play'){
                this.playCamYaw -= e.movementX * 0.002;
                this.playCamPitch -= e.movementY * 0.002;
                this.playCamPitch = Math.max(-1.5, Math.min(1.5, this.playCamPitch));
            }
        });

        Gizmo.init(this.scene);
        this.loop();
    },

    createPlayerAvatar: function(user){
        const group = new THREE.Group();
        const matBody = new THREE.MeshLambertMaterial({ color: user.avatar.body });
        const matShirt = new THREE.MeshLambertMaterial({ color: user.avatar.shirtColor });
        const matPants = new THREE.MeshLambertMaterial({ color: user.avatar.pantsColor });

        const torso = new THREE.Mesh(new THREE.BoxGeometry(1.2, 1.4, 0.65), matShirt); torso.name = 'torso'; torso.position.y = 1.0;
        const head = new THREE.Mesh(new THREE.BoxGeometry(0.65, 0.65, 0.65), matBody); head.name = 'head'; head.position.y = 2.025;
        const lArm = new THREE.Mesh(new THREE.BoxGeometry(0.625, 1.3, 0.625), matBody); lArm.name = 'lArm'; lArm.position.set(-0.92, 1.05, 0);
        const rArm = new THREE.Mesh(new THREE.BoxGeometry(0.625, 1.3, 0.625), matBody); rArm.name = 'rArm'; rArm.position.set(0.92, 1.05, 0);
        const lLeg = new THREE.Mesh(new THREE.BoxGeometry(0.625, 1.3, 0.625), matPants); lLeg.name='lLeg'; lLeg.position.set(-0.3, -0.35, 0);
        const rLeg = new THREE.Mesh(new THREE.BoxGeometry(0.625, 1.3, 0.625), matPants); rLeg.name='rLeg'; rLeg.position.set(0.3, -0.35, 0);

        group.add(torso); group.add(head); group.add(lArm); group.add(rArm); group.add(lLeg); group.add(rLeg);
        group.userData.parts = { torso, head, lArm, rArm, lLeg, rLeg };
        return group;
    },

    spawnObject: function(type, pos, color, scale, userData){
        let geo = new THREE.BoxGeometry(2,2,2);
        let col = color || 0xcccccc;
        if(type === 'spawn'){ geo = new THREE.CylinderGeometry(1.5,1.5,0.2,16); col = 0x888888; }
        if(type === 'kill') col = 0xff0000;
        if(type === 'finish'){ col = 0xffd700; geo = new THREE.BoxGeometry(3,0.2,3); }
        if(type === 'light'){ col = 0xffffaa; geo = new THREE.SphereGeometry(0.5); }
        const mat = new THREE.MeshLambertMaterial({ color: col });
        const mesh = new THREE.Mesh(geo, mat);
        if(pos) mesh.position.copy(pos); else mesh.position.set(0,1,0);

        if(scale && typeof scale === 'object') {
            mesh.scale.set(scale.x || 1, scale.y || 1, scale.z || 1);
        }

        mesh.userData = Object.assign({ type: type }, (userData || {}));
        this.scene.add(mesh);
        this.objects.push(mesh);

        if(type === 'light'){
            const l = new THREE.PointLight(0xffffaa,1,15);
            mesh.add(l);
        }
        return mesh;
    },

    onStudioClick: function(e){
        const rect = this.renderer.domElement.getBoundingClientRect();
        this.mouse.x = ((e.clientX - rect.left) / rect.width) * 2 - 1;
        this.mouse.y = -((e.clientY - rect.top) / rect.height) * 2 + 1;
        this.raycaster.setFromCamera(this.mouse, this.camera);
        const gizHits = Gizmo.intersectHandles(this.raycaster);
        if(gizHits && gizHits.length > 0){ Gizmo.handlePointerDown(gizHits[0], e); return; }
        const hits = this.raycaster.intersectObjects(this.objects, true);
        if(hits.length > 0){
            this.selectedStudioObj = hits[0].object;
            let root = this.selectedStudioObj;
            while(root && !root.userData.type && root.parent) root = root.parent;
            if(root && root.userData.type) this.selectedStudioObj = root;
            Gizmo.attachTo(this.selectedStudioObj);
            UI.updateStudioExplorer();
            UI.updatePropPanel();
        } else {
            this.selectedStudioObj = null;
            Gizmo.detach();
            UI.updateStudioExplorer();
            UI.updatePropPanel();
        }
    },

    loop: function(){
        if(document.getElementById('app-viewport').style.display === 'none') return;
        this.loopId = requestAnimationFrame(()=>this.loop());

        if(this.mode === 'studio'){
            const speed = 0.4;
            if(this.controls['w']) this.camera.translateZ(-speed);
            if(this.controls['s']) this.camera.translateZ(speed);
            if(this.controls['a']) this.camera.translateX(-speed);
            if(this.controls['d']) this.camera.translateX(speed);
            if(this.controls['q']) this.camera.position.y += speed;
            if(this.controls['e']) this.camera.position.y -= speed;
            if(!this.studioState.panning && !this.studioState.draggingGizmo){
                const center = (this.selectedStudioObj || { position:new THREE.Vector3(0,0,0) }).position || new THREE.Vector3(0,0,0);
                const dist = this.camera.position.distanceTo(center);
                const camX = center.x + dist * Math.sin(this.playCamYaw) * Math.cos(this.playCamPitch);
                const camY = center.y + dist * Math.sin(this.playCamPitch);
                const camZ = center.z + dist * Math.cos(this.playCamYaw) * Math.cos(this.playCamPitch);
                this.camera.position.lerp(new THREE.Vector3(camX,camY,camZ), 0.12);
                this.camera.lookAt(center);
            }
            Gizmo.update();
        }

        if (this.mode === 'play' && this.players.length > 0) {
            const p = this.players[0].mesh;
            const speed = 0.15;
            const dir = new THREE.Vector3();

            if (this.controls['w']) dir.z = -1;
            if (this.controls['s']) dir.z = 1;
            if (this.controls['a']) dir.x = -1;
            if (this.controls['d']) dir.x = 1;

            const moving = dir.length() > 0;

            if (moving) {
                dir.normalize().applyAxisAngle(new THREE.Vector3(0, 1, 0), this.playCamYaw);
                p.position.add(dir.multiplyScalar(speed));
                p.rotation.y = Math.atan2(dir.x, dir.z);
            }

            if (this.controls.space && p.userData.onGround) { p.userData.velocityY = 0.25; p.userData.onGround = false; }
            p.userData.velocityY -= 0.01;
            p.position.y += p.userData.velocityY;
            p.userData.onGround = false;

            if (p.position.y <= 1) { p.position.y = 1; p.userData.velocityY = 0; p.userData.onGround = true; }

            const playerBox = new THREE.Box3().setFromObject(p);
            this.objects.forEach(obj => {
                if (!obj.userData || obj.userData.type !== 'block') return;
                const objBox = new THREE.Box3().setFromObject(obj);
                const feetY = playerBox.min.y;
                const blockTopY = objBox.max.y;
                const onTop = playerBox.max.x > objBox.min.x && playerBox.min.x < objBox.max.x && playerBox.max.z > objBox.min.z && playerBox.min.z < objBox.max.z && feetY <= blockTopY && feetY >= blockTopY - 0.35 && p.userData.velocityY <= 0;
                if (onTop) { p.position.y = blockTopY + (p.position.y - feetY); p.userData.velocityY = 0; p.userData.onGround = true; }
            });

            const box = new THREE.Box3().setFromObject(p);
            this.objects.forEach(obj => {
                if (obj.userData?.type === 'kill' && new THREE.Box3().setFromObject(obj).intersectsBox(box)) {
                    p.userData.health = (p.userData.health || 100) - 25;
                    if (p.userData.health <= 0) {
                        const spawn = this.currentGame.mapData.find(x => x.type === 'spawn');
                        p.position.set(spawn ? spawn.pos.x : 0, 5, spawn ? spawn.pos.z : 0);
                        p.userData.velocityY = 0;
                        p.userData.health = 100;
                        API.notify('You died and respawned');
                    } else {
                        API.notify('You were hit! Health: ' + p.userData.health);
                        p.userData.velocityY = 0.15;
                    }
                    this.updateHealthHUD(p.userData.health || 0);
                }
            });

            const camDist = 8;
            const camX = p.position.x + camDist * Math.sin(this.playCamYaw) * Math.cos(this.playCamPitch);
            const camY = p.position.y + 1.2 + camDist * Math.sin(this.playCamPitch);
            const camZ = p.position.z + camDist * Math.cos(this.playCamYaw) * Math.cos(this.playCamPitch);
            this.camera.position.lerp(new THREE.Vector3(camX, camY, camZ), 0.2);
            this.camera.lookAt(p.position.clone().add(new THREE.Vector3(0, 0.75, 0)));

            try {
                const parts = p.userData.parts || (p.userData.parts = {});
                if (!parts.lArm) { parts.lArm = p.getObjectByName('lArm'); parts.rArm = p.getObjectByName('rArm'); parts.lLeg = p.getObjectByName('lLeg'); parts.rLeg = p.getObjectByName('rLeg'); }
                if (!p.userData._lastPos) { p.userData._lastPos = p.position.clone(); }
                const dx = p.position.x - p.userData._lastPos.x;
                const dz = p.position.z - p.userData._lastPos.z;
                const isMoving = Math.sqrt(dx * dx + dz * dz) > 0.002;
                p.userData._lastPos.copy(p.position);
                const t = Date.now() / 100;
                const stride = isMoving ? 0.6 : 0.1;
                const jumping = !p.userData.onGround || p.userData.velocityY > 0;
                let armL = Math.sin(t) * 0.15 * stride;
                let armR = Math.sin(t + Math.PI) * 0.15 * stride;
                const legL = Math.sin(t + Math.PI) * 0.12 * stride;
                const legR = Math.sin(t) * 0.12 * stride;
                if (jumping) { const lift = Math.min(1, Math.abs(p.userData.velocityY) * 6); armL = -0.6 * lift; armR = -0.6 * lift; }
                if (parts.lArm) parts.lArm.rotation.x = armL;
                if (parts.rArm) parts.rArm.rotation.x = armR;
                if (parts.lLeg) parts.lLeg.rotation.x = legL;
                if (parts.rLeg) parts.rLeg.rotation.x = legR;
            } catch (e) {}
        }

        this.renderer.render(this.scene, this.camera);
    },

    updateHealthHUD: function(value){
        const wrap = document.getElementById('health-bar-wrap');
        const fill = document.getElementById('health-bar-fill');
        const txt = document.getElementById('health-text');
        if(!wrap) return;
        wrap.style.display = (this.mode === 'play') ? 'flex' : 'none';
        const val = Math.max(0, Math.min(100, value));
        fill.style.width = val + '%';
        txt.innerText = val + '%';
    },

    exit: function(){ cancelAnimationFrame(this.loopId); document.getElementById('app-viewport').style.display = 'none'; document.exitPointerLock?.(); Router.go(this.mode === 'studio' ? 'create' : 'games'); },
    openSettings: function(){ document.getElementById('in-game-settings').style.display = 'flex'; document.exitPointerLock?.(); },
    closeSettings: function(){ document.getElementById('in-game-settings').style.display = 'none'; if(this.mode==='play') this.renderer.domElement.requestPointerLock(); }
};

/* ========================================================================== 
   Gizmo manager
   ========================================================================== */
const Gizmo = (function(){
    let scene = null; let handles = []; let attachedTo = null; let visible = false; let dragState = null;
    const PX_TO_WORLD = 0.01; 
    const STEP = 0.01; 

    function init(scn){
        scene = scn;
        for(let i=0;i<6;i++){
            const geo = new THREE.SphereGeometry(0.12,8,8);
            const mat = new THREE.MeshBasicMaterial({ color: i<3 ? (i===0?0xff0000: i===1?0x00ff00:0x0000ff) : 0xffff00 });
            const h = new THREE.Mesh(geo, mat);
            h.userData = { handleIndex: i };
            h.visible = false;
            scene.add(h); handles.push(h);
        }
    }

    function attachTo(obj){ attachedTo = obj; update(); visible = true; handles.forEach(h => h.visible = true); }
    function detach(){ attachedTo = null; handles.forEach(h => h.visible = false); visible = false; }

    function update(){
        if(!attachedTo) return;
        const pos = attachedTo.position.clone();
        const bbox = new THREE.Box3().setFromObject(attachedTo);
        const sizeVec = bbox.getSize(new THREE.Vector3());
        const size = Math.max(0.5, Math.max(sizeVec.x, sizeVec.y, sizeVec.z));
        handles[0].position.copy(pos).add(new THREE.Vector3(size*0.6,0,0));
        handles[1].position.copy(pos).add(new THREE.Vector3(0,size*0.6,0));
        handles[2].position.copy(pos).add(new THREE.Vector3(0,0,size*0.6));
        handles[3].position.copy(pos).add(new THREE.Vector3(size*0.9,0,0));
        handles[4].position.copy(pos).add(new THREE.Vector3(0,size*0.9,0));
        handles[5].position.copy(pos).add(new THREE.Vector3(0,0,size*0.9));
    }

    function intersectHandles(raycaster){ if(!visible) return null; return raycaster.intersectObjects(handles, true); }

    function handlePointerDown(hit, e){
        if(!attachedTo) return;
        const idx = hit.object.userData.handleIndex;
        dragState = { handleIndex: idx, startMouse:{x:e.clientX,y:e.clientY}, startPos: attachedTo.position.clone(), startScale: attachedTo.scale.clone(), accum:0, lastStep:0 };
        Engine.studioState.draggingGizmo = true;
    }

    function handlePointerMove(e){
        if(!dragState || !attachedTo) return;
        const idx = dragState.handleIndex;
        let deltaPx = 0;
        if(idx === 0) deltaPx = e.movementX;
        if(idx === 1) deltaPx = -e.movementY;
        if(idx === 2) deltaPx = -e.movementY;
        dragState.accum += deltaPx * PX_TO_WORLD;
        const steps = Math.round(dragState.accum / STEP);
        if(steps === dragState.lastStep) return;
        const deltaSteps = steps - dragState.lastStep;
        dragState.lastStep = steps;
        const deltaWorld = deltaSteps * STEP;

        if(idx >=0 && idx <=2){
            const newPos = attachedTo.position.clone();
            const comp = newPos.getComponent(idx) + deltaWorld;
            newPos.setComponent(idx, parseFloat(comp.toFixed(5)));
            attachedTo.position.copy(newPos);
        } else {
            const axis = idx - 3;
            const s = attachedTo.scale.clone();
            const newVal = Math.max(0.01, s.getComponent(axis) + deltaWorld);
            s.setComponent(axis, parseFloat(newVal.toFixed(5)));
            attachedTo.scale.copy(s);
        }
        UI.updateStudioExplorer();
        UI.updatePropPanel();
        update();
    }

    function handlePointerUp(e){ if(!dragState) return; dragState = null; Engine.studioState.draggingGizmo = false; Studio.saveLocal(); }

    return { init, attachTo, detach, update, intersectHandles, handlePointerDown, handlePointerMove, handlePointerUp };
})();

/* ========================================================================== 
   AvatarRenderer
   ========================================================================== */
const AvatarRenderer = {
    render: function(user, divId){
        const div=document.getElementById(divId); if(!div) return; div.innerHTML='';
        const scene=new THREE.Scene();
        const camera=new THREE.PerspectiveCamera(50,Math.max(1,div.clientWidth/div.clientHeight),0.1,100);
        camera.position.set(0,1.55,5);
        camera.rotation.x = -THREE.MathUtils.degToRad(10);
        const renderer=new THREE.WebGLRenderer({alpha:true,antialias:true});
        renderer.setSize(div.clientWidth,div.clientHeight);
        div.appendChild(renderer.domElement);

        const light=new THREE.DirectionalLight(0xffffff,1.2); light.position.set(2,5,5);
        scene.add(light); scene.add(new THREE.AmbientLight(0x555555));

        const group=new THREE.Group();
        const matBody=new THREE.MeshLambertMaterial({color:user.avatar.body});
        const matShirt=new THREE.MeshLambertMaterial({color:user.avatar.shirtColor});
        const matPants=new THREE.MeshLambertMaterial({color:user.avatar.pantsColor});

        if(user.avatar.shirt){
            const it=DB.catalog.find(i=>i.id===user.avatar.shirt);
            if(it?.url) new THREE.TextureLoader().load(it.url,t=>{matShirt.map=t;matShirt.needsUpdate=true;});
        }
        if(user.avatar.pants){
            const it=DB.catalog.find(i=>i.id===user.avatar.pants);
            if(it?.url) new THREE.TextureLoader().load(it.url,t=>{matPants.map=t;matPants.needsUpdate=true;});
        }

        const torso = new THREE.Mesh( new THREE.BoxGeometry(1.2, 1.4, 0.65), matShirt ); torso.name = 'torso'; torso.position.y = 1.0; 
        const head = new THREE.Mesh( new THREE.BoxGeometry(0.65, 0.65, 0.65), matBody ); head.name = 'head'; head.position.y = 2.025; 
        const lArm = new THREE.Mesh( new THREE.BoxGeometry(0.625, 1.3, 0.625), matBody ); lArm.name = 'lArm'; lArm.position.set(-0.92, 1.05, 0); 
        const rArm = new THREE.Mesh( new THREE.BoxGeometry(0.625, 1.3, 0.625), matBody ); rArm.name = 'rArm'; rArm.position.set(0.92, 1.05, 0); 
        const lLeg = new THREE.Mesh(new THREE.BoxGeometry(0.625, 1.3, 0.625), matPants); lLeg.name='lLeg'; lLeg.position.set(-0.3, -0.35, 0); 
        const rLeg = new THREE.Mesh(new THREE.BoxGeometry(0.625, 1.3, 0.625), matPants); rLeg.name='rLeg'; rLeg.position.set(0.3, -0.35, 0);

        if(user.avatar.face){
            const it=DB.catalog.find(i=>i.id===user.avatar.face);
            if(it?.url) new THREE.TextureLoader().load(it.url,t=>{ t.flipY=true; });
        }

        if(user.avatar.hat){
            const it=DB.catalog.find(i=>i.id===user.avatar.hat);
            if(it?.url) new THREE.TextureLoader().load(it.url,t=>{
                const hat=new THREE.Mesh(new THREE.BoxGeometry(0.8,0.18,0.8),new THREE.MeshLambertMaterial({map:t,transparent:true}));
                hat.position.y=1.95; group.add(hat);
            });
            else{
                const hat=new THREE.Mesh(new THREE.BoxGeometry(0.8,0.18,0.8),new THREE.MeshLambertMaterial({color:0x111111}));
                hat.position.y=1.95; group.add(hat);
            }
        }

        group.add(torso,head,lArm,rArm,lLeg,rLeg);
        scene.add(group);

        function animate(){ requestAnimationFrame(animate); group.rotation.y+=0.01; renderer.render(scene,camera); }
        animate();
    }
};

/* ========================================================================== 
   Studio persistence helpers
   ========================================================================== */
const Studio = {
    createDisplay: function(){
        const name = prompt("Name your universe:");
        if(!name) return;
        const newGame = { id:Date.now(), name:name, creator:API.user.username, description:"", public:false, mapData:[], thumbnailColor:'#'+Math.floor(Math.random()*16777215).toString(16), votes:{}, comments:[] };
        DB.games.push(newGame); DB.save(); UI.renderCreate();
    },

    addPart: function(type){
        const cam = Engine.camera;
        const vec = new THREE.Vector3(0,0,-5).applyQuaternion(cam.quaternion).add(cam.position);
        const obj = Engine.spawnObject(type, vec);
        obj.userData.audio = obj.userData.audio || null;
        obj.userData.asset = obj.userData.asset || null;
        Studio.saveLocal(); UI.updateStudioExplorer();
    },

    // NEW DUPLICATE FEATURE
    duplicatePart: function(){
        if(!Engine.selectedStudioObj) return API.notify("Select part first","error");
        const original = Engine.selectedStudioObj;
        
        // Serialize user data to clone it deeply
        const userDataClone = JSON.parse(JSON.stringify(original.userData));
        
        // Clone mesh data
        const pos = original.position.clone().add(new THREE.Vector3(2, 0, 0)); // offset by 2
        const color = original.material.color.getHex();
        const scale = original.scale.clone();
        
        const newObj = Engine.spawnObject(userDataClone.type, pos, color, scale, userDataClone);
        
        // Select the new one
        Engine.selectedStudioObj = newObj;
        Gizmo.attachTo(newObj);
        UI.updateStudioExplorer();
        UI.updatePropPanel();
        Studio.saveLocal();
        API.notify("Part Duplicated");
    },

    saveLocal: function(){
        if(!Engine.currentGame) return;
        const mapData = Engine.objects.filter(o=>o.userData.type).map(obj => ({
            type: obj.userData.type,
            pos: { x: obj.position.x, y: obj.position.y, z: obj.position.z },
            color: obj.material && obj.material.color ? obj.material.color.getHex() : 0xcccccc,
            scale: { x: obj.scale.x, y: obj.scale.y, z: obj.scale.z },
            userData: obj.userData
        }));
        Engine.currentGame.mapData = mapData;
        const idx = DB.games.findIndex(g => g.id === Engine.currentGame.id);
        if(idx !== -1) DB.games[idx] = Engine.currentGame;
        DB.save();
    },

    publishModal: function(){
        const isPub = confirm("Publish to world? (Cancel = Private)");
        Engine.currentGame.public = isPub;
        this.saveLocal();
        API.notify(isPub ? "Published!" : "Set to Private");
    }
};

/* ========================================================================== 
   Studio UI
   ========================================================================== */
UI.updateStudioExplorer = function(){
    const ex = document.getElementById('studio-explorer');
    ex.innerHTML = Engine.objects.filter(o=>o.userData.type).map((o,i) => `<div class="explorer-item ${Engine.selectedStudioObj === o ? 'active' : ''}" onclick="Engine.selectedStudioObj = Engine.objects.filter(x=>x.userData.type)[${i}]; Gizmo.attachTo(Engine.selectedStudioObj); UI.updateStudioExplorer(); UI.updatePropPanel();">${o.userData.type.toUpperCase()}</div>`).join('');
};

UI.updatePropPanel = function(){
    const p = document.getElementById('prop-panel');
    const o = Engine.selectedStudioObj;
    if(!o) return p.innerHTML = 'Select an object';
    const hex = '#' + (o.material && o.material.color ? o.material.color.getHex().toString(16).padStart(6,'0') : 'cccccc');
    const audioUrl = o.userData && o.userData.audio ? (o.userData.audio.url || '') : '';
    p.innerHTML = `<div style="margin-bottom:10px;">TYPE: ${o.userData.type}</div>
        <label>Color</label><input type="color" value="${hex}" oninput="if(Engine.selectedStudioObj && Engine.selectedStudioObj.material){ Engine.selectedStudioObj.material.color.set(this.value); Studio.saveLocal(); }">
        <label>X</label><input type="number" value="${o.position.x}" onchange="Engine.selectedStudioObj.position.x=parseFloat(this.value); Studio.saveLocal();">
        <label>Y</label><input type="number" value="${o.position.y}" onchange="Engine.selectedStudioObj.position.y=parseFloat(this.value); Studio.saveLocal();">
        <label>Z</label><input type="number" value="${o.position.z}" onchange="Engine.selectedStudioObj.position.z=parseFloat(this.value); Studio.saveLocal();">
        <label>Scale X</label><input type="number" value="${o.scale.x}" step="0.1" onchange="Engine.selectedStudioObj.scale.x=parseFloat(this.value); Studio.saveLocal();">
        <label>Scale Y</label><input type="number" value="${o.scale.y}" step="0.1" onchange="Engine.selectedStudioObj.scale.y=parseFloat(this.value); Studio.saveLocal();">
        <label>Scale Z</label><input type="number" value="${o.scale.z}" step="0.1" onchange="Engine.selectedStudioObj.scale.z=parseFloat(this.value); Studio.saveLocal();">
        <label>Attach Audio URL (100 Coins)</label><input type="text" id="prop-audio-url" placeholder="http://...mp3" value="${audioUrl}">
        <div style="display:flex;gap:8px;margin-top:8px;"><button class="btn btn-sm btn-primary" onclick="UI.attachAudioToSelected()">Attach Audio</button><button class="btn btn-sm btn-outline" onclick="UI.removeAudioFromSelected()">Remove Audio</button></div>
        
        <hr style="border:0;border-top:1px solid var(--border);margin:12px 0;">
        <button class="btn btn-outline btn-sm" style="width:100%;margin-bottom:8px;" onclick="Studio.duplicatePart()">Duplicate Part</button>
        <button class="btn btn-danger btn-sm" style="width:100%;" onclick="Engine.scene.remove(Engine.selectedStudioObj); Engine.objects.splice(Engine.objects.indexOf(Engine.selectedStudioObj),1); Engine.selectedStudioObj=null; Studio.saveLocal(); UI.updateStudioExplorer(); UI.updatePropPanel();">Delete</button>`;
};

UI.attachAudioToSelected = function(){
    const url = document.getElementById('prop-audio-url').value.trim();
    if(!url) return API.notify('Provide an audio URL','error');
    if(!Engine.selectedStudioObj) return API.notify('Select an object','error');
    const audioItem = { id: Date.now(), type:'audio', name: 'Audio - ' + (Engine.selectedStudioObj.userData.type || 'part'), price:100, creator: API.user.username, url:url, approved: true };
    DB.catalog.push(audioItem);
    Engine.selectedStudioObj.userData.audio = { url: url, catalogId: audioItem.id, price: audioItem.price, creator: API.user.username };
    Studio.saveLocal();
    API.notify('Audio attached and added to catalog at 100 coins');
    UI.renderCreatorCatalog();
};

UI.removeAudioFromSelected = function(){
    if(!Engine.selectedStudioObj || !Engine.selectedStudioObj.userData.audio) return API.notify('No audio attached','error');
    delete Engine.selectedStudioObj.userData.audio;
    Studio.saveLocal();
    API.notify('Audio removed from selected part');
};

/* ========================================================================== 
   Boot sequence & global key handling
   ========================================================================== */
window.addEventListener('load', () => {
    API.init();

    window.addEventListener('keydown', (e) => {
        const tag = (document.activeElement && document.activeElement.tagName) || '';
        if(tag === 'INPUT' || tag === 'TEXTAREA' || document.activeElement.isContentEditable) return;
        const k = e.key.toLowerCase();
        if(k === 'w' || k === 'a' || k === 's' || k === 'd' || k === 'q' || k === 'e' || k === ' ') { e.preventDefault && e.preventDefault(); }
        if(k in Engine.controls) Engine.controls[k] = true;
        if(e.code === 'Space') Engine.controls.space = true;
        if(k === 'g' && API.user && API.user.isAdmin) UI.toggleAdminModal();
    });

    window.addEventListener('keyup', (e) => {
        const tag = (document.activeElement && document.activeElement.tagName) || '';
        if(tag === 'INPUT' || tag === 'TEXTAREA' || document.activeElement.isContentEditable) return;
        const k = e.key.toLowerCase();
        if(k in Engine.controls) Engine.controls[k] = false;
        if(e.code === 'Space') Engine.controls.space = false;
    });
});

/* ========================================================================== 
   Expose for debugging
   ========================================================================== */
window.Engine = Engine;
window.UI = UI;
window.API = API;
window.Studio = Studio;
window.Admin = Admin;
window.Gizmo = Gizmo;
window.AvatarRenderer = AvatarRenderer;
</script>

</body>
</html>